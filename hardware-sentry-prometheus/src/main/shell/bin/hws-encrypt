#!/bin/sh

# Licensed under the Sentry Free Software License Agreement.
# See the LICENSE file distributed with this work for additional
# information regarding copyright ownership.
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

# -----------------------------------------------------------------------------
# Hardware Sentry Prometheus Exporter Encrypt Script
#
# Environment Variable Prerequisites
#
#   JAVA_HOME       Must point at a Java Runtime Environment, version 11 or
#                   greater.
#   HWS_JAVA_OPTS   (Optional) Java runtime options used when Hardware Sentry
#                   Prometheus Exporter is executed.
# -----------------------------------------------------------------------------

# Resolve links - $0 may be a link to Hardware Sentry Prometheus Exporter's home
PRG="$0"

# Need this for relative symlinks
while [ -h "$PRG" ] ; do
	ls=`ls -ld "$PRG"`
	link=`expr "$ls" : '.*-> \(.*\)$'`
	if expr "$link" : '/.*' > /dev/null; then
		PRG="$link"
	else
		PRG="`dirname "$PRG"`/$link"
	fi
done

# Remember where we are
saveddir=`pwd`

HWS_HOME=`dirname "$PRG"`/..

# Make it fully qualified
HWS_HOME=`cd "$HWS_HOME" && pwd`

# Go back to where we were
cd "$saveddir"

# Check JAVA_HOME
if [ -z "$JAVA_HOME" ] ; then
	JAVACMD=`which java`
else
	JAVACMD="$JAVA_HOME/bin/java"
fi

if [ ! -x "$JAVACMD" ] ; then
  echo "The JAVA_HOME environment variable is not defined correctly." >&2
  echo "JAVA_HOME must point to a JRE version 11 or greater." >&2
  exit 1
fi

HWS_JAR=`echo "$HWS_HOME"/lib/${project.artifactId}-${project.version}.jar`

HWS_PASSWORD_ENCRYPT_LOADER="-Dloader.main=com.sentrysoftware.hardware.prometheus.security.PasswordEncrypt org.springframework.boot.loader.PropertiesLauncher"

exec "$JAVACMD" $HWS_JAVA_OPTS -cp "${HWS_JAR}" ${HWS_PASSWORD_ENCRYPT_LOADER} "$@"
