---
connector:
  displayName: Fujitsu-Siemens ServerView RAID Agent
  platforms: Fujitsu-Siemens PRIMERGY
  reliesOn: Fujitsu-Siemens Serverview RAID Agent
  version: 1.0
  information: This connector provides disk monitoring through the Fujitsu-Siemens Serverview RAID SNMP sub-agent which supports many RAID controllers in Primergy servers.
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - NT
    - Linux
    supersedes:
    - Director52ServeRAIDNT
    criteria:
    # Simply check that the FSC RAID MIB is populated with some disks
    - type: snmpGetNext
      oid: 1.3.6.1.4.1.231.2.49.1.5.2.1
monitors:
  disk_controller:
    discovery:
      sources:
        source(1):
          # Source(1) = svrCtrlTable controllers table
          # DeviceID;ControllerNumber;Model;Manufacturer;FirmwareVersion;BIOSVersion
          type: snmpTable
          oid: 1.3.6.1.4.1.231.2.49.1.4.2.1
          selectColumns: "ID,1,2,3,7,8"
      mapping:
        # The Instance table...
        source: "${source::monitors.disk_controller.discovery.sources.source(1)}"
        attributes:
          id: $1
          controller_number: $2
          vendor: $4
          model: $3
          firmware_version: $5
          bios_version: $6
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"Disk Controller: %s (%s %s)\", $2, $4, $3)}"
    collect:
      # Collect type is multi-instance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = svrCtrlTable controllers table
          # DeviceID;BBUStatus
          type: snmpTable
          oid: 1.3.6.1.4.1.231.2.49.1.4.2.1
          selectColumns: "ID,14"
          computes:
            # Translate the BBUStatus into a BatteryStatus
            # DeviceID;BatteryStatus
          - type: translate
            column: 2
            translationTable: "${translation::BatteryStatusTranslationTable}"
      mapping:
        # ValueTable = Source(1)
        source: "${source::monitors.disk_controller.collect.sources.source(1)}"
        deviceId: $1
  physical_disk:
    discovery:
      sources:
        source(1):
          # Source(1) = svrPhysicalDevice SNMP table
          # DeviceID;ControllerNumber;Vendor;SizeGB;DeviceType;SerialNumber
          type: snmpTable
          oid: 1.3.6.1.4.1.231.2.49.1.5.2.1
          selectColumns: "ID,1,6,7,9,17"
          computes:
            # Keep only disks
            # DeviceID;ControllerNumber;Vendor;SizeGB;DeviceType;SerialNumber
          - type: keepOnlyMatchingLines
            column: 5
            valueList: 2
            # Convert size from GB to bytes
            # DeviceID;ControllerNumber;Vendor;Size;DeviceType;SerialNumber
          - type: multiply
            column: 4
            value: 1073741824
      mapping:
        # InstanceTable = Source(1)
        source: "${source::monitors.physical_disk.discovery.sources.source(1)}"
        attributes:
          id: $1
          vendor: $3
          serial_number: $6
          hw.parent.type: disk_controller
          hw.parent.id: "lookup(\"disk_controller\", \"id\", \"controller_number\", $2)"
          name: "${awk::sprintf(\"%s (%s - %s)\", $1, $3, bytes2HumanFormatBase10($4))}"
        metrics:
          hw.physical_disk.size: $4
    collect:
      # This is a multi-instance collect (execute the collect for each disk)
      type: multiInstance
      sources:
        source(1):
          # Source(1) = svrPhysicalDevice SNMP table
          # ID;errors;SmartStatus;Status
          type: snmpTable
          oid: 1.3.6.1.4.1.231.2.49.1.5.2.1
          selectColumns: "ID,12,14,15"
          computes:
            # Duplicate the Status column
            # ID;errors;SmartStatus;Status;Status
          - type: duplicateColumn
            column: 4
            # translate the first Status into PATROL status
            # ID;errors;SmartStatus;PATROLStatus;Status
          - type: translate
            column: 4
            translationTable: "${translation::PhysicalDiskStatusTranslationTable}"
            # translate the snmp state into a more readable string
            # ID;errors;SmartStatus;PATROLStatus;StatusInformation
          - type: translate
            column: 5
            translationTable: "${translation::PhysicalDiskStatusInformationTranslationTable}"
            # Translate SmartStatus into PredictedFailure
            # ID;errors;PredictedFailure;PATROLStatus;StatusInformation
          - type: translate
            column: 3
            translationTable: "${translation::PhysicalDiskSmartStatusTranslationTable}"
      mapping:
        # ValueTable = Source(1)
        source: "${source::monitors.physical_disk.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.status{hw.type="physical_disk"}: $4
          hw.errors{hw.type="physical_disk"}: $2
          hw.status{hw.type="physical_disk", state="predicted_failure"}: boolean($3)
        legacyTextParameters:
          StatusInformation: $5
  logical_disk:
    discovery:
      sources:
        source(1):
          # Source(1) = the svrLogicalDrive SNMP table
          # DeviceID;ControllerNumber;SizeGB;RAIDCode
          type: snmpTable
          oid: 1.3.6.1.4.1.231.2.49.1.6.2.1
          selectColumns: "ID,1,3,5"
          computes:
            # Convert size in bytes
            # DeviceID;ControllerNumber;SizeGB;RAIDCode
          - type: multiply
            column: 3
            value: 1073741824
            # Translate RAIDCode into RAIDLevel
            # DeviceID;ControllerNumber;SizeGB;RAIDLevel
          - type: translate
            column: 4
            translationTable: "${translation::RAIDLevelTranslationTable}"
      mapping:
        # The instance table
        source: "${source::monitors.logical_disk.discovery.sources.source(1)}"
        attributes:
          id: $1
          raid_level: $4
          hw.parent.type: disk_controller
          hw.parent.id: "lookup(\"disk_controller\", \"id\", \"controller_number\", $2)"
          name: "${awk::sprintf(\"%s (%s - %s)\", $1, $4, bytes2HumanFormatBase2($3))}"
        metrics:
          hw.logical_disk.limit: $3
    collect:
      # Type = MultiInstance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = the svrLogicalDrive SNMP table
          # DeviceID;Status
          type: snmpTable
          oid: 1.3.6.1.4.1.231.2.49.1.6.2.1
          selectColumns: "ID,10"
          computes:
            # Duplicate the status column
            # DeviceID;Status;Status
          - type: duplicateColumn
            column: 2
            # translate the snmp status into PATROL status
            # DeviceID;PATROLStatus;Status
          - type: translate
            column: 2
            translationTable: "${translation::LogicalDiskStatusTranslationTable}"
            # translate the snmp status into a more readable string
            # DeviceID;PATROLStatus;StatusInformation
          - type: translate
            column: 3
            translationTable: "${translation::LogicalDiskStatusInformationTranslationTable}"
      mapping:
        # ValueTable = Source(1)
        source: "${source::monitors.logical_disk.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.status{hw.type="logical_disk"}: $2
        legacyTextParameters:
          StatusInformation: $3
translations:
  PhysicalDiskSmartStatusTranslationTable:
    "1": 0
    "2": 1
    "3": 0
    "4": 0
    Default: 0
  RAIDLevelTranslationTable:
    "11": 5e
    "12": 5ee
    "13": 6
    "14": ""
    "15": ""
    "16": 60
    Default: ""
    "1": ""
    "2": 0
    "3": 0+1
    "4": 1
    "5": 1e
    "6": 10
    "7": 3
    "8": 4
    "9": 5
    "10": 50
  PhysicalDiskStatusInformationTranslationTable:
    "11": Formatting
    "12": Dead
    "2": Not a hard disk
    "3": ""
    "4": Ready
    "5": Failed
    "6": Rebuilding
    "7": Hotspare
    "8": Hotspare
    "9": Offline
    Default: Unknown Status
    "10": Failed (Unconfigured)
  BatteryStatusTranslationTable:
    "7": failed
    Default: ok
  LogicalDiskStatusInformationTranslationTable:
    "2": ""
    "3": Degraded
    "4": Offline
    "5": Rebuilding
    "6": Verifying
    "7": Initializing
    "8": Morphing
    "9": Partially Degraded
    Default: Unknown Status
  LogicalDiskStatusTranslationTable:
    "2": ok
    "3": degraded
    "4": failed
    "5": degraded
    "6": degraded
    "7": ok
    "8": degraded
    "9": degraded
    Default: UNKNOWN
  PhysicalDiskStatusTranslationTable:
    "11": ok
    "12": failed
    "2": failed
    "3": ok
    "4": ok
    "5": failed
    "6": degraded
    "7": ok
    "8": ok
    "9": failed
    Default: UNKNOWN
    "10": degraded
