---
connector:
  displayName: LsiLogic MegaRAID SAS (Newer Controllers)
  platforms: Fujitsu-Siemens PRIMERGY
  reliesOn: LSI MegaRAID SAS SNMP Agent
  version: 1.0
  information: This connector provides disk monitoring through the LsiLogic MegaRAID SAS SNMP sub-agent which supports newer LSI MegaRaid SAS RAID controllers.
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - NT
    - Linux
    supersedes:
    - LSIMegaCliWindows
    criteria:
    # Simply check that the LSI MegaRaid SAS MIB is populated with some disks
    - type: snmpGetNext
      oid: 1.3.6.1.4.1.3582.5.1.4.2.1.2.1
monitors:
  disk_controller:
    discovery:
      sources:
        source(1):
          # LSI MegaRAID SAS controllers table
          # DeviceID;ControllerNumber;Interface;FirmwareVersion;DriverVersion
          type: snmpTable
          oid: 1.3.6.1.4.1.3582.5.1.4.1.1.3.1
          selectColumns: "ID,1,9,14,15"
          computes:
            # Add "MegaRaid " to the Interface column so that it will look like a model
            # DeviceID;ControllerNumber;Model;FirmwareVersion;DriverVersion
          - type: leftConcat
            column: 3
            value: 'MegaRaid '
      mapping:
        # The Instance table...
        source: "${source::monitors.disk_controller.discovery.sources.source(1)}"
        attributes:
          id: $1
          controller_number: $2
          vendor: LSI
          model: $3
          firmware_version: $4
          driver_version: $5
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"Disk Controller: %s (%s %s)\", $2, \"LSI\", $3)}"
  physical_disk:
    discovery:
      sources:
        source(1):
          # Source(1) = physicalDriveTable SNMP table
          # DeviceID;Type;SizeKB;ControllerNumber;Vendor
          type: snmpTable
          oid: 1.3.6.1.4.1.3582.5.1.4.2.1.2.1
          selectColumns: "ID,4,15,22,24"
          computes:
            # Keep only disks
            # DeviceID;Type;SizeKB;ControllerNumber;Vendor
          - type: keepOnlyMatchingLines
            column: 2
            valueList: 0
            # Convert size from KB to bytes
            # DeviceID;Type;Size;ControllerNumber;Vendor
          - type: multiply
            column: 3
            value: 1048576
      mapping:
        # InstanceTable = Source(1)
        source: "${source::monitors.physical_disk.discovery.sources.source(1)}"
        attributes:
          id: $1
          vendor: $5
          hw.parent.type: disk_controller
          hw.parent.id: "lookup(\"disk_controller\", \"id\", \"controller_number\", $4)"
          name: "${awk::sprintf(\"%s (%s - %s)\", $1, $5, bytes2HumanFormatBase10($3))}"
        metrics:
          hw.physical_disk.size: $3
    collect:
      # This is a multi-instance collect (execute the collect for each disk)
      type: multiInstance
      keys:
      - id
      sources:
        source(1):
          # Source(1) = the physical disk table
          # ID;mediaErrors;otherErrors;PredictedFailureErrors;state
          type: snmpTable
          oid: 1.3.6.1.4.1.3582.5.1.4.2.1.2.1
          selectColumns: "ID,7,8,9,10"
          computes:
            # Duplicate the state column
            # ID;mediaErrors;otherErrors;PredictedFailureErrors;state;state
          - type: duplicateColumn
            column: 5
            # translate the snmp state into PATROL status
            # ID;mediaErrors;otherErrors;PredictedFailureErrors;PATROLStatus;state
          - type: translate
            column: 5
            translationTable: "${translation::PhysicalDiskStatusTranslationTable}"
            # translate the snmp state into a more readable string
            # ID;mediaErrors;otherErrors;PredictedFailureErrors;PATROLStatus;statusInformation
          - type: translate
            column: 6
            translationTable: "${translation::PhysicalDiskStatusInformationTranslationTable}"
            # Add up errors
            # ID;totalErrorCount;otherErrors;PredictedFailureErrors;PATROLStatus;statusInformation
          - type: add
            column: 2
            value: $3
          - type: add
            column: 2
            value: $4
      mapping:
        # ValueTable = Source(1)
        source: "${source::monitors.physical_disk.collect.sources.source(1)}"
        attributes:
          id: $1
        metrics:
          hw.status{hw.type="physical_disk"}: $5
          hw.errors{hw.type="physical_disk"}: $2
        legacyTextParameters:
          StatusInformation: $6
  logical_disk:
    discovery:
      sources:
        source(1):
          # Source(1) = the snmp virtualDriveTable
          # DeviceID;SizeMB;RAIDLevel;ControllerNumber
          type: snmpTable
          oid: 1.3.6.1.4.1.3582.5.1.4.3.1.2.1
          selectColumns: "ID,2,11,20"
          computes:
            # Convert size in bytes
            # DeviceID;Size;RAIDLevel;ControllerNumber
          - type: multiply
            column: 2
            value: 1048576
      mapping:
        # The instance table
        source: "${source::monitors.logical_disk.discovery.sources.source(1)}"
        attributes:
          id: $1
          raid_level: $3
          hw.parent.type: disk_controller
          hw.parent.id: "lookup(\"disk_controller\", \"id\", \"controller_number\", $4)"
          name: "${awk::sprintf(\"%s (%s - %s)\", $1, $3, bytes2HumanFormatBase2($2))}"
        metrics:
          hw.logical_disk.limit: $2
    collect:
      # Type = MultiInstance
      type: multiInstance
      keys:
      - id
      sources:
        source(1):
          # Source(1) = the status of the drive in the logical drive snmp table
          # DeviceID;Status
          type: snmpTable
          oid: 1.3.6.1.4.1.3582.5.1.4.3.1.2.1
          selectColumns: "ID,5"
          computes:
            # Duplicate the status column
            # DeviceID;Status;Status
          - type: duplicateColumn
            column: 2
            # translate the snmp status into PATROL status
            # DeviceID;PATROLStatus;Status
          - type: translate
            column: 2
            translationTable: "${translation::LogicalDiskStatusTranslationTable}"
            # translate the snmp status into a more readable string
            # DeviceID;PATROLStatus;StatusInformation
          - type: translate
            column: 3
            translationTable: "${translation::LogicalDiskStatusInformationTranslationTable}"
      mapping:
        # ValueTable = Source(1)
        source: "${source::monitors.logical_disk.collect.sources.source(1)}"
        attributes:
          id: $1
        metrics:
          hw.status{hw.type="logical_disk"}: $2
        legacyTextParameters:
          StatusInformation: $3
translations:
  PhysicalDiskStatusInformationTranslationTable:
    "0": Unconfigured
    "1": Failed (Unconfigured)
    "2": Hotspare
    "24": ""
    "16": Offline
    "17": Failed
    Default: Unknown Status
    "20": Rebuilding
  LogicalDiskStatusInformationTranslationTable:
    "0": Offline
    "1": Partially Degraded
    "2": Degraded
    "3": ""
    Default: Unknown Status
  LogicalDiskStatusTranslationTable:
    "0": failed
    "1": degraded
    "2": degraded
    "3": ok
    Default: UNKNOWN
  PhysicalDiskStatusTranslationTable:
    "0": ok
    "1": degraded
    "2": ok
    "24": ok
    "16": degraded
    "17": failed
    Default: UNKNOWN
    "20": degraded
