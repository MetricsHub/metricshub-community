---
extends:
- HitachiSNM2CLI-header
constants:
  _EF1_COMMAND_PART2: ;
  _EF1_COMMAND_PART1: "/bin/sh $embedded.EmbeddedFile(1)$ %{USERNAME} %{PASSWORD}"
embedded:
  EmbeddedFile(1): |-
    username=$1
    password=$2
    export STONAVM_ACT=on
    export STONAVM_RSP_PASS=on
    export MS_HW_pwdfile=$RANDOM
    if [ -n STONAVM_HOME ]; then
            echo $password>$STONAVM_HOME/$MS_HW_pwdfile
            $STONAVM_HOME/auaccountenv -set -uid $username -passwdfile $STONAVM_HOME/$MS_HW_pwdfile
            UNITLIST=`$STONAVM_HOME/auunitref | /usr/bin/tail -n +2 | /bin/awk '{print $1}'`
            for UNIT in $UNITLIST
                    do
                    echo $password>$STONAVM_HOME/$MS_HW_pwdfile
                    $STONAVM_HOME/auaccountenv -set -uid $username -passwdfile $STONAVM_HOME/$MS_HW_pwdfile
                    echo MS_HW_SYSTEM_START $UNIT
                    $STONAVM_HOME/$3 $4 $5 -unit $UNIT
                    echo MS_HW_SYSTEM_END $UNIT
                    done
             $STONAVM_HOME/auaccountenv -rm
            fi
connector:
  displayName: Hitachi HDS AMS/HUS (SNM2 CLI on Linux)
  platforms: "Hitachi AMS,Hitachi HUS"
  reliesOn: Hitachi SNM2 CLI
  version: 1.0
  information: "This connector discovers the status of Hitachi AMS/HUS's Processors, CSW, Cache, SM, Power Supplies, Batteries, Fans, Physical Disks and Environment."
  detection:
    connectionTypes:
    - remote
    appliesTo:
    - Storage
    disableAutoDetection: true
    criteria:
      # Check we are running these commands locally on a Linux Server
      # LINUX ONLY
    - type: osCommand
      commandLine: uname
      errorMessage: Connector only works on a server running Linux
      expectedResult: Linux
      executeLocally: true
      forceSerialization: true
      # STONAVM_HOME should be defined
      # LINUX ONLY
    - type: osCommand
      commandLine: "if [ -n \"$STONAVM_HOME\" ]; then echo STONAVM_HOME Defined; fi"
      errorMessage: STONAVM_HOME is not defined
      expectedResult: STONAVM_HOME Defined
      executeLocally: true
      forceSerialization: true
      # STONAVM_HOME should be defined
      # LINUX ONLY
    - type: osCommand
      commandLine: "if [ -n \"$LD_LIBRARY_PATH\" ]; then echo LD_LIBRARY_PATH Defined; fi"
      errorMessage: LD_LIBRARY_PATH is not defined
      expectedResult: LD_LIBRARY_PATH Defined
      executeLocally: true
      forceSerialization: true
      # We should be able to authenticate
      # LINUX ONLY
    - type: osCommand
      commandLine: "export STONAVM_RSP_PASS=on;echo %{PASSWORD}>$STONAVM_HOME/MS_HW_pwdfile;$STONAVM_HOME/auaccountenv -set -uid %{USERNAME} -passwdfile $STONAVM_HOME/MS_HW_pwdfile"
      errorMessage: SNM2 CLI is unable to authenticate.
      expectedResult: The account information has been set successfully
      executeLocally: true
      forceSerialization: true
