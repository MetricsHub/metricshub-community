---
connector:
  detection:
    criteria:
    - type: osCommand
      commandLine: _EsxcliConstant system version get
      expectedResult: "Version: [567]"
      executeLocally: _ExecuteLocally
    # Check that there are FC LUNs
    - type: osCommand
      commandLine: _EsxcliConstant storage core path list
      expectedResult: "Transport: fc"
      executeLocally: _ExecuteLocally
monitors:
  lun:
    discovery:
      sources:
        source(1):
          # Get the list of LUNs from esxcli storage core path list
          type: osCommand
          commandLine: _EsxcliConstant storage core path list
          executeLocally: _ExecuteLocally
          computes:
            # AWK it
            # MSHW;LunName;LunInfo;NumberPaths;LunStatusInfo;
            # LunName;LunInfo;
          - type: awk
            script: $file("embeddedFile-1")$
            keep: ^MSHW;
            separators: ;
            selectColumns: "2,3"
      mapping:
        # InstanceTable = Source(1)
        # LunName;LunInfo;
        source: $monitors.lun.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          __display_id: $column(1)
          array_name: $column(2)
          hw.parent.type: enclosure
          name: $column(2)
    collect:
      # Collect type is multi-instance
      type: multiInstance
      sources:
        source(1):
          # Get the list of LUNs from esxcli storage core path list
          type: osCommand
          commandLine: _EsxcliConstant storage core path list
          executeLocally: _ExecuteLocally
          computes:
            # AWK it
            # MSHW;LunName;LunInfo;NumberPaths;LunStatusInfo;
            # LunName;NumberPaths;LunStatusInfo;
          - type: awk
            script: $file("embeddedFile-1")$
            keep: ^MSHW;
            separators: ;
            selectColumns: "2,4,5"
      mapping:
        # ValueTable = Source(1)
        # LunName;NumberPaths;LunStatusInfo;
        source: $monitors.lun.collect.sources.source(1)$
        deviceId: $column(1)
        metrics:
          hw.lun.paths: $column(2)
        legacyTextParameters:
          AvailablePathInformation: $column(3)
  other_device:
    discovery:
      sources:
        source(1):
          # Get the list of SD Cards from esxcli storage core device list
          type: osCommand
          commandLine: _EsxcliConstant storage core device list
          executeLocally: _ExecuteLocally
          computes:
            # AWK it
            # Type;USBID;Vendor;Model;
          - type: awk
            script: $file("embeddedFile-2")$
            keep: ^MSHW;
            separators: ;
            selectColumns: "2,3,4,5"
      mapping:
        # InstanceTable = Source(1)
        # Type;USBID;Vendor;Model;
        source: $monitors.other_device.discovery.sources.source(1)$
        attributes:
          id: $column(2)
          __display_id: $column(2)
          device_type: $column(1)
          info: "join($column(3), $column(4), \" \")"
          hw.parent.type: enclosure
          name: "sprintf(\"%s: %s\", $column(1), $column(2))"
    collect:
      # Collect type is multi-instance
      type: multiInstance
      sources:
        source(1):
          # Get the list of SD Cards from esxcli storage core device list
          type: osCommand
          commandLine: _EsxcliConstant storage core device list
          executeLocally: _ExecuteLocally
          computes:
            # AWK it
            # USBID;Status;StatusInformation;
          - type: awk
            script: $file("embeddedFile-2")$
            keep: ^MSHW;
            separators: ;
            selectColumns: "3,6,7"
            # Patrol Status comes from Status
            # USBID;PatrolStatus;StatusInformation;
          - type: translate
            column: 2
            translationTable: statusTranslationTable
      mapping:
        # ValueTable = Source(1)
        # USBID;Status;StatusInformation;
        source: $monitors.other_device.collect.sources.source(1)$
        deviceId: $column(1)
        metrics:
          hw.status{hw.type="other_device"}: $column(2)
        legacyTextParameters:
          StatusInformation: $column(3)
translations:
  statusTranslationTable:
    dead: failed
    Default: degraded
    "off": ok
    "on": ok
