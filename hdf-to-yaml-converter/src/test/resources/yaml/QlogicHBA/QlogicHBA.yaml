---
connector:
  displayName: QLogic HBAs - VMware ESX
  platforms: Any system with QLogic
  reliesOn: QLogic CIM Agent for VMware ESX
  version: 1.0
  information: This connector discovers the QLogic HBAs of a server. It relies on the WBEM technology.
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - Linux
    - OOB
    supersedes:
    - QlogicSCLI
    criteria:
    # There must be FC Ports declared in the QLogic/cimv2 namespace
    - type: wbem
      query: SELECT PortType FROM QLogicFC_Port
      namespace: qlogic/cimv2
      expectedResult: \(0\)\|\(1\)\|\(10\)\|\(11\)\|\(12\);
monitors:
  network:
    discovery:
      sources:
        source(1):
          # Source(1) = CIM_FCPort
          # InstanceID;PortTypeCode;PortWWN;PhyPortNumber;NodeWWN;Speed;AdapterModel;VPDData;
          type: wbem
          query: "SELECT InstanceID,PortType,PortName,PhyPortNumber,NodeName,Speed,AdapterModel,VPDData FROM QLogicFC_Port"
          namespace: qlogic/cimv2
          computes:
            # Translate PortType into a more readable string
            # InstanceID;PortType;PortWWN;PhyPortNumber;NodeWWN;Speed;AdapterModel;VPDData;
          - type: translate
            column: 2
            translationTable: "${translation::PortTypeTranslationTable}"
            # Convert Speed from bps to Mbps (divide by 1062500)
            # InstanceID;PortType;PortWWN;PhyPortNumber;NodeWWN;Speed;AdapterModel;VPDData;
          - type: divide
            column: 6
            value: 1062500
            # Remove the dashes from the WWNs
            # InstanceID;PortType;PortWWN;PhyPortNumber;NodeWWN;Speed;AdapterModel;VPDData;
          - type: replace
            column: 3
            existingValue: '-'
            newValue: ""
          - type: replace
            column: 4
            existingValue: '-'
            newValue: ""
          # Add \"VPD Data: \" for AdditionalInformation1
          - type: leftConcat
            column: 8
            value: "VPD Data: "
      mapping:
        # InstanceTable = Source(10)
        # InstanceID;PortType;PortWWN;PhyPortNumber;NodeWWN;Speed;AdapterModel;VPDData;
        source: "${source::monitors.network.discovery.sources.source(1)}"
        attributes:
          id: $1
          __display_id: $4
          model: $7
          vendor: QLogic
          bandwidth: $6
          physical_address: $3
          physical_address_type: WWN
          device_type: $2
          info: $8
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"%s (%s - %s - %s)\", $4, $2, \"QLogic\", $7)}"
    collect:
      # The NetworkCard collect is a "MultiInstance" collect
      type: multiInstance
      sources:
        source(1):
          # Source(1) = CIM_FCPort
          # InstanceID;Speed;LinkStatus;
          type: wbem
          query: "SELECT InstanceID,Speed,LinkStatus FROM QLogicFC_Port"
          namespace: qlogic/cimv2
          computes:
            # Translate the Link Status
            # InstanceID;Speed;PatrolLinkStatus;
          - type: translate
            column: 3
            translationTable: "${translation::LinkStatusTranslationTable}"
            # Convert Speed from bps to Mbps (divide by 1062500)
            # InstanceID;Speed;PatrolLinkStatus;
          - type: divide
            column: 2
            value: 1062500
      mapping:
        # ValueTable = Source(1)
        # InstanceID;Speed;PatrolLinkStatus;
        source: "${source::monitors.network.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.network.up: legacyLinkStatus($3)
          hw.network.bandwidth.limit: megaBit2Bit($2)
translations:
  PortTypeTranslationTable:
    "11": HBA FC Port NL
    "12": HBA FC Port F/NL
    Default: HBA FC Port
    "10": HBA FC Port N
  LinkStatusTranslationTable:
    "0": ok
    ? ""
    : degraded
    Default: degraded
