---
connector:
  displayName: HP-UX - Network
  platforms: "HP 9000,HP Integrity,HP SuperDome"
  reliesOn: "HP-UX system commands (lanscan, etc.)"
  information: Discovers and monitors Ethernet adapters.
  version: 1.0
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - HP
    supersedes:
    - HPUXWBEMNetwork
    criteria:
    # OS should be HP (for HP-UX, whatever version)
    - type: deviceType
      keep:
      - HP
    # The various following tools have to be present
    - type: osCommand
      commandLine: /usr/sbin/lanscan
      expectedResult: "^[0-9]+/[0-9]+/[0-9]+"
monitors:
  network:
    discovery:
      sources:
        source(1):
          # Source(1) = output of EmbeddedFile(1)
          type: osCommand
          commandLine: "for IF in `/usr/sbin/lanscan|/usr/bin/awk '($3 ~ /[0-9]+/) && ($1 ~ \"[0-9]+/[0-9]+/[0-9]+\") { print $3 }'`; do /usr/sbin/lanadmin -g mibstats $IF; done"
          computes:
            # Process the output of the command through an AWK script
            # DeviceID;MacAddress;Model;
          - type: awk
            script: "${file::embeddedFile-1}"
            keep: ^MSHW;
            separators: ;
            selectColumns: "2,3,8"
      mapping:
        # InstanceTable = Source(1)
        source: "${source::monitors.network.discovery.sources.source(1)}"
        attributes:
          id: $1
          physical_address: $2
          physical_address_type: MAC
          model: $3
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"%s (%s)\", $1, $3)}"
    collect:
      # Collect type is multi-instance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = Ouput of lanadmin for all lan adapters listed by lanscan
          type: osCommand
          commandLine: "for IF in `/usr/sbin/lanscan|/usr/bin/awk '($3 ~ /[0-9]+/) && ($1 ~ \"[0-9]+/[0-9]+/[0-9]+\") { print $3 }'`; do /usr/sbin/lanadmin -g mibstats $IF; done"
          computes:
            # Process the output of the command through an AWK script
            # DeviceID;MacAddress;Model;
          - type: awk
            script: "${file::embeddedFile-1}"
            keep: ^MSHW;
            separators: ;
            selectColumns: "2,4,5,6,7,9,10,11"
            # Extract the number of the status column
            # DeviceID;Speed; Status; ErrorCount; Inbound Packets; outboundPackets; inboundOctet; outboundOctet;
          - type: extract
            column: 3
            subSeparators: ()
            subColumn: 2
            # Duplicate the status column
            # DeviceID;Speed; Status; Status; ErrorCount; Inbound Packets; outboundPackets; inboundOctet; outboundOctet;
          - type: duplicateColumn
            column: 3
            # Duplicate again the status column
            # DeviceID;Speed; Status; Status; Status; ErrorCount; Inbound Packets; outboundPackets; inboundOctet; outboundOctet;
          - type: duplicateColumn
            column: 3
            # Translate the first STatusNumber column into a PATROL status
            # DeviceID;Speed; Patrol Status; Status; Status; ErrorCount; Inbound Packets; outboundPackets; inboundOctet; outboundOctet;
          - type: translate
            column: 3
            translationTable: "${translation::NetworkCardStatusTranslationTable}"
            # Translate the second StatusNumber column into a more readable string
            # DeviceID;Speed; Patrol Status; Status Information ; Status; ErrorCount; Inbound Packets; outboundPackets; inboundOctet; outboundOctet;
          - type: translate
            column: 4
            translationTable: "${translation::NetworkCardStatusInformationTranslationTable}"
            # Translate the third StatusNumber column into LinkStatus
            # DeviceID;Speed; Patrol Status; Status Information ; Link Status; ErrorCount; Inbound Packets; outboundPackets; inboundOctet; outboundOctet;
          - type: translate
            column: 5
            translationTable: "${translation::NetworkCardLinkStatusTranslationTable}"
      mapping:
        # Value table = Source(1)
        #     1      2        # 3        #     4        #          5        #  6        #   7        #         8        #      9        #    10
        # DeviceID;Speed; Patrol Status; Status Information ; Link Status; ErrorCount; Inbound Packets; outboundPackets; inboundOctet; outboundOctet;
        source: "${source::monitors.network.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.status{hw.type="network"}: $3
          hw.network.up: legacyLinkStatus($5)
          hw.errors{hw.type="network"}: $6
          hw.network.packets{direction="transmit"}: $8
          hw.network.packets{direction="receive"}: $7
          hw.network.io{direction="transmit"}: $10
          hw.network.io{direction="receive"}: $9
          hw.network.bandwidth.limit: megaBit2Bit($2)
        legacyTextParameters:
          StatusInformation: $4
translations:
  NetworkCardLinkStatusTranslationTable:
    "1": ok
    "2": degraded
    "3": ok
    "5": ok
    "6": ok
    "7": degraded
    Default: ok
  NetworkCardStatusInformationTranslationTable:
    "1": Up
    "2": Down
    "3": Testing
    "5": Dormant
    "6": Not present
    "7": Lower layer down
    Default: Unknown Status
  NetworkCardStatusTranslationTable:
    "1": ok
    "2": ok
    "3": degraded
    "5": ok
    "6": failed
    "7": failed
    Default: UNKNOWN
