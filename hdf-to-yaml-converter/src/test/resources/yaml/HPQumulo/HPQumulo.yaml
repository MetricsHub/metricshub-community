---
connector:
  displayName: HP Qumulo
  platforms: HP Qumulo storage systems
  reliesOn: QQ CLI
  information: Gives hardware information HP Qumulo storage systems.
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - Storage
    - NT
    - Linux
    criteria:
    # Checks that QQ CLI is present on target host
    - type: osCommand
      commandLine: qq --help
      expectedResult: Qumulo CLI
      errorMessage: QQ CLI not found on local host.
      executeLocally: true
monitors:
  enclosure:
    discovery:
      sources:
        source(1):
          # Discovery
          # Source(1) = Output of the QQ CLI command through OS Commands
          type: osCommand
          commandLine: "qq --host %{HOSTNAME} nodes_list"
          timeout: 90
          executeLocally: true
          computes:
            # Parse the output of the command with an AWK script
            # ID;displayId;model;serial;uuid;status;status
          - type: awk
            script: "${file::embeddedFile-1}"
      mapping:
        # ID;displayId;model;serial;uuid;status;status
        source: "${source::monitors.enclosure.discovery.sources.source(1)}"
        attributes:
          id: $1
          __display_id: $2
          model: $3
          serial_number: $4
          vendor: HP
          info: $5
          name: "${awk::sprintf(\"Enclosure: %s (%s %s)\", $2, \"HP\", $3)}"
    collect:
      sources:
        source(1):
          # Collect
          # Source(1) = Output of the QQ CLI command through OS Commands
          type: osCommand
          commandLine: "qq --host %{HOSTNAME} nodes_list"
          timeout: 90
          executeLocally: true
          computes:
            # Parse the output of the command with an AWK script
            # ID;displayId;model;serial;uuid;status;status
          - type: awk
            script: "${file::embeddedFile-1}"
            # Translate status
            # ID;displayId;model;serial;uuid;status;statusInformation
          - type: translate
            column: 6
            translationTable: "${translation::EnclosureStatusTranslationTable}"
      mapping:
        # ID;displayId;model;serial;uuid;status;statusInformation
        source: "${source::monitors.enclosure.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.status{hw.type="enclosure"}: $6
        legacyTextParameters:
          StatusInformation: $7
  physical_disk:
    discovery:
      sources:
        source(1):
          # Discovery
          # Source(1) = Output of the QQ CLI command through OS Commands
          type: osCommand
          commandLine: "qq --host %{HOSTNAME} cluster_slots"
          timeout: 90
          executeLocally: true
          computes:
            # Parse the output of the command with an AWK script
            # ID;nodeId;model;serial;slot;slotType;size;status;status
          - type: awk
            script: "${file::embeddedFile-2}"
      mapping:
        # ID;nodeId;model;serial;slot;slotType;size;status;status
        source: "${source::monitors.physical_disk.discovery.sources.source(1)}"
        attributes:
          id: $1
          __display_id: $5
          model: $3
          serial_number: $4
          info: $6
          hw.parent.type: enclosure
          hw.parent.id: $2
          name: "${awk::sprintf(\"%s (%s)\", $5, bytes2HumanFormatBase10($7))}"
        metrics:
          hw.physical_disk.size: $7
    collect:
      sources:
        source(1):
          # Collect
          # Source(1) = Output of the QQ CLI command through OS Commands
          type: osCommand
          commandLine: "qq --host %{HOSTNAME} cluster_slots"
          timeout: 90
          executeLocally: true
          computes:
            # Parse the output of the command with an AWK script
            # ID;nodeId;model;serial;slot;slotType;size;status;status
          - type: awk
            script: "${file::embeddedFile-2}"
            # Translate status
            # ID;nodeId;model;serial;slot;slotType;size;status;statusInformation
          - type: translate
            column: 8
            translationTable: "${translation::PhysicalDiskStatusTranslationTable}"
      mapping:
        # ID;nodeId;model;serial;slot;slotType;size;status;statusInformation
        source: "${source::monitors.physical_disk.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.status{hw.type="physical_disk"}: $8
        legacyTextParameters:
          StatusInformation: $9
  network:
    discovery:
      sources:
        source(1):
          # Discovery
          # Source(1) = Output of the QQ CLI command through OS Commands
          type: osCommand
          commandLine: "qq --host %{HOSTNAME} network_poll"
          timeout: 90
          executeLocally: true
          computes:
            # Parse the output of the command with an AWK script
            # ID;nodeId;ip;mac;speed;bytesSent;bytesReceived;linkStatus;status;status
          - type: awk
            script: "${file::embeddedFile-3}"
      mapping:
        # ID;nodeId;ip;mac;speed;bytesSent;bytesReceived;linkStatus;status;status
        source: "${source::monitors.network.discovery.sources.source(1)}"
        attributes:
          id: $1
          __display_id: $1
          logical_address: $3
          physical_address: $4
          device_type: Ethernet
          logical_address_type: IP
          physical_address_type: MAC
          hw.parent.type: enclosure
          hw.parent.id: $2
          name: "${awk::sprintf(\"%s (%s)\", $1, \"Ethernet\")}"
    collect:
      sources:
        source(1):
          # Collect
          # Source(1) = Output of the QQ CLI command through OS Commands
          type: osCommand
          commandLine: "qq --host %{HOSTNAME} cluster_slots"
          timeout: 90
          executeLocally: true
          computes:
            # Parse the output of the command with an AWK script
            # ID;nodeId;ip;mac;speed;bytesSent;bytesReceived;linkStatus;status;status
          - type: awk
            script: "${file::embeddedFile-3}"
            # Translate status
            # ID;nodeId;ip;mac;speed;bytesSent;bytesReceived;linkStatus;status;status
          - type: translate
            column: 9
            translationTable: "${translation::NetworkCardStatusTranslationTable}"
            # Translate linkStatus
            # ID;nodeId;ip;mac;speed;bytesSent;bytesReceived;linkStatus;status;status
          - type: translate
            column: 8
            translationTable: "${translation::LinkStatusTranslationTable}"
      mapping:
        # ID;nodeId;ip;mac;speed;bytesSent;bytesReceived;linkStatus;status;status
        source: "${source::monitors.network.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.network.io{direction="transmit"}: $6
          hw.network.io{direction="receive"}: $7
          hw.status{hw.type="network"}: $8
        legacyTextParameters:
          StatusInformation: $9
translations:
  LinkStatusTranslationTable:
    CONNECTED: ok
    Default: degraded
  EnclosureStatusTranslationTable:
    online: ok
    Default: degraded
  PhysicalDiskStatusTranslationTable:
    healthy: ok
    Default: degraded
  NetworkCardStatusTranslationTable:
    UP: ok
    Default: degraded
