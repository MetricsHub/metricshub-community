---
extends:
- MIB2-header
translations:
  TempStatusInformationTranslationTable:
    "1": Over Heating
    "2": ok
  StatusInformationTranslationTable:
    "1": Unknow
    "2": Bad
    default: Unknown Status
    "3": Warning
    "4": Good
    "5": Not Present
  StatusTranslationTable:
    "1": UNKNOWN
    "2": failed
    default: UNKNOWN
    "3": degraded
    "4": ok
    "5": failed
  TempStatusTranslationTable:
    "1": failed
    "2": ok
connector:
  displayName: HP Procurve (SNMP)
  platforms: HP Procurve
  reliesOn: HP Procurve (HP-ICF-CHASSIS)
  version: 1.0
  information: "This connector discovers the enclosure, fans, power supplies, temperatures, etc. of HP Procurve Network Switches."
  detection:
    connectionTypes:
    - remote
    appliesTo:
    - Network
    supersedes:
    - GenericSwitchEnclosure
    - MIB2
    criteria:
    # Check that there are HP Sensors OIDs
    - type: snmpGetNext
      oid: 1.3.6.1.4.1.11.2.14.11.1.2.6.1
monitors:
  enclosure:
    discovery:
      sources:
        source(1):
          # Enclosure
          # Identifier, display, Firmware, bios
          type: snmpTable
          oid: 1.3.6.1.4.1.11.2.14.11.1.2.4.1
          selectColumns: "1,4,4,4"
          computes:
            # replace all the spaces in descrition with separator to use them in instance table
            # / eg: HP J9265A Switch 6600ml-24XG, revision K.15.09.0012, ROM K.15.29 (/ws/swbuildm/K_rel_hartford_qaoff/code/build/btm(K_rel_hartford_qaoff)) (Formerly ProCurve)
            # id, description
            # Identifier, display, Firmware, bios
          - type: extract
            column: 2
            subColumn: 1
            subSeparators: ","
          # Identifier, display, Firmware, bios
          - type: extract
            column: 3
            subColumn: 2
            subSeparators: ","
          - type: leftConcat
            column: 3
            value: "Firmware: "
          # Identifier, display, Firmware, bios
          - type: extract
            column: 4
            subColumn: 3
            subSeparators: ","
        source(2):
          # Get the sensor list to use them in other sources
          # id,status,description,
          type: snmpTable
          oid: 1.3.6.1.4.1.11.2.14.11.1.2.6.1
          selectColumns: "1,4,7"
          computes:
            # remove keyword sensors from description
            # id, Status, description
          - type: replace
            column: 3
            existingValue: Sensor
            newValue: ""
            # Exclude sensors marked as not prosent
            # id, Status, desciption
          - type: excludeMatchingLines
            column: 2
            valueList: 5
      mapping:
        # Identifier, display, Firmware, bios
        source: $monitors.enclosure.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          __display_id: $column(2)
          type: Switch
          bios_version: $column(4)
          info: $column(3)
          name: "sprintf(\"%s (%s)\", $column(2), \"Switch\")"
    collect:
      sources:
        source(1):
          # Get the sensor list to use them in other sources
          # id,patrolstatus,statusinformation,
          type: snmpTable
          oid: 1.3.6.1.4.1.11.2.14.11.1.2.6.1
          selectColumns: "1,4,4"
          computes:
          - type: translate
            column: 2
            translationTable: StatusTranslationTable
          - type: translate
            column: 3
            translationTable: StatusInformationTranslationTable
  power_supply:
    discovery:
      sources:
        source(1):
          type: copy
          from: $monitors.enclosure.discovery.sources.source(2)$
          computes:
            # keep only power supplies
            # id, Status, description
          - type: keepOnlyMatchingLines
            column: 3
            regExp: Power Supply
      mapping:
        # Instance Table
        source: $monitors.power_supply.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          __display_id: $column(3)
          hw.parent.type: enclosure
          name: "sprintf(\"%s, $column(3))"
    collect:
      # Collect type = multi-instance
      type: multiInstance
      sources:
        source(1):
          type: copy
          from: $monitors.enclosure.collect.sources.source(1)$
      mapping:
        # Instance Table
        # id,patrolstatus,statusinformation,
        source: $monitors.power_supply.collect.sources.source(1)$
        deviceId: $column(1)
        metrics:
          hw.status{hw.type="power_supply"}: $column(2)
        legacyTextParameters:
          StatusInformation: $column(3)
  fan:
    discovery:
      sources:
        source(1):
          type: copy
          from: $monitors.enclosure.discovery.sources.source(2)$
          computes:
            # keep only power supplies
            # id, Status, description
          - type: keepOnlyMatchingLines
            column: 3
            regExp: fan
      mapping:
        # Instance Table
        source: $monitors.fan.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          __display_id: $column(3)
          hw.parent.type: enclosure
          name: $column(3)
    collect:
      # Collect type = multi-instance
      type: multiInstance
      sources:
        source(1):
          type: copy
          from: $monitors.enclosure.collect.sources.source(1)$
      mapping:
        # Instance Table
        # id,patrolstatus,statusinformation,
        source: $monitors.fan.collect.sources.source(1)$
        deviceId: $column(1)
        metrics:
          hw.status{hw.type="fan"}: $column(2)
        legacyTextParameters:
          StatusInformation: $column(3)
  temperature:
    discovery:
      sources:
        source(1):
          # ID, Name, threshold
          type: snmpTable
          oid: 1.3.6.1.4.1.11.2.14.11.1.2.8.1.1
          selectColumns: "ID,2,7"
          computes:
          # remove celcius from current reading
          - type: replace
            column: 3
            existingValue: C
            newValue: ""
      mapping:
        # Instance Table
        source: $monitors.temperature.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          __display_id: $column(2)
          hw.parent.type: enclosure
          name: $column(2)
        metrics:
          hw.temperature.limit{limit_type="high.critical"}: $column(3)
    collect:
      # Collect type = multi-instance
      type: multiInstance
      sources:
        source(1):
          # ID;current;Status (based on overtemp);StatusInformation
          type: snmpTable
          oid: 1.3.6.1.4.1.11.2.14.11.1.2.8.1.1
          selectColumns: "ID,3,6,6"
          computes:
          # remove celcius from current reading
          - type: replace
            column: 2
            existingValue: C
            newValue: ""
          - type: translate
            column: 3
            translationTable: TempStatusTranslationTable
          - type: translate
            column: 4
            translationTable: TempStatusInformationTranslationTable
      mapping:
        # Instance Table
        source: $monitors.temperature.collect.sources.source(1)$
        deviceId: $column(1)
        metrics:
          hw.temperature: $column(2)
          hw.status{hw.type="temperature"}: $column(3)
        legacyTextParameters:
          StatusInformation: $column(4)
  network:
    discovery:
      mapping:
        # add network card discovery present in mib2.hdf and not in mib2.hhdf
        # PortID;Description;TypeCode;MacAddress;AdminStatus;ID;Name;Alias;
        source: $monitors.network.discovery.sources.source(3)$
        attributes:
          id: $column(1)
          __display_id: $column(7)
          physical_address: $column(4)
          physical_address_type: MAC
          device_type: $column(3)
          hw.parent.type: enclosure
          name: "sprintf(\"%s (%s)\", $column(7), $column(3))"
