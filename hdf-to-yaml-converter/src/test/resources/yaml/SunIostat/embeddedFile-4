DISKLIST=`/usr/bin/iostat -En|/usr/bin/awk '{
    if ($0 ~ /^c[0-9]+t[0-9A-Z]+d[0-9]+/ || $0 ~ /^s+d[0-9]+/)
    {
        disk = $1
        product = ""
    }

    if ($0 ~ /Product: /)
    {
        index1 = index($0, "Product: " ) + length("Product: ")
        product = substr($0, index1, length-index1)
        index1 = index(product, ":")
        if (index1 > 0)
        {
            product = substr(product, 1, index1-1)
            n = split(product, a, " ")
            product = ""
            for (i=1 ; i<n ; i++)
            {
                product = product a[i]
                if (i < n-1)
                    product = product " "
            }
        }
    }
    if ($0 ~ /Size: /)
    {
        index1 = index($0, "<") + 1
        index2 = index($0, " bytes>")
        size = substr($0, index1, index2-index1)
    }
    if ($0 ~/Illegal Request:/)
    {
        if (disk != "" && product ~ /SUN[0-9\.]+[GT]/ && size > 10)
        {
            print disk
        }

        disk = ""
        product = ""
    }
}'|/usr/bin/head -30`

LANG=C
export LANG

for DISK in $DISKLIST
do

    if /usr/bin/echo $DISK|/usr/bin/grep "^c[0-9][0-9]*t[0-9A-Z][0-9A-Z]*d[0-9][0-9]*" 2>/dev/null >/dev/null; then
        CTDSLIST=`/usr/bin/ls /dev/rdsk/$DISK"s"* 2>/dev/null`
    else
        DRIVERNAME=`/usr/bin/echo $DISK|/usr/bin/tr -d [:digit:]`
        INSTANCENUMBER=`/usr/bin/echo $DISK|/usr/bin/tr -d [:alpha:]`
        DEVICEPATH=`/usr/xpg4/bin/awk -v instanceNumber=$INSTANCENUMBER -v driverName=$DRIVERNAME '($(NF-1) == instanceNumber) && ($NF == "\""driverName"\"") { print $1 }' /etc/path_to_inst|/usr/bin/tr -d \"`
        CTDSLIST=`/usr/bin/ls -l /dev/rdsk/c*|/usr/xpg4/bin/awk -v devicePath="$DEVICEPATH" '($NF ~ devicePath && devicePath != "") { print $(NF-2); }'`
    fi

    if /usr/bin/test -z "$CTDSLIST" ; then
        /usr/bin/echo "MSHW;$DISK;UNKNOWN;Couldn't find corresponding block device";
    else
        FOUNDWORKINGCTDS=0
        for CTDS in $CTDSLIST
        do
            ERRORMESSAGE=`%{SUDO:/usr/bin/dd}/usr/bin/dd if=$CTDS of=/dev/null count=20 2>&1`
            if /usr/bin/test "$?" = "0" ; then
                /usr/bin/echo "MSHW;$DISK;OK;Working"
                FOUNDWORKINGCTDS=1
                break
            fi
        done
        if /usr/bin/test "$FOUNDWORKINGCTDS" == "0" ; then
            ERRORMESSAGE=`/usr/bin/echo $ERRORMESSAGE|/usr/bin/awk -F: '($4 !~ /denied/ && $4 !~ /[Nn]o such file/) {print $4}'`
            if /usr/bin/test -z "$ERRORMESSAGE" ; then
                /usr/bin/echo "MSHW;$DISK;UNKNOWN;Unknown Status";
            else
                /usr/bin/echo "MSHW;$DISK;ALARM;$ERRORMESSAGE";
            fi
        fi
    fi
done