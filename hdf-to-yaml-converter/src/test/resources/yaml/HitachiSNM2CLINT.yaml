---
extends:
- HitachiSNM2CLI-header
constants:
  _EF1_COMMAND_PART2: '& del /F /Q %EmbeddedFile(1)%.bat'
  _EF1_COMMAND_PART1: "copy %EmbeddedFile(1)% %EmbeddedFile(1)%.bat & %EmbeddedFile(1)%.bat %{USERNAME} %{PASSWORD}"
embedded:
  EmbeddedFile(1): "@echo off\nset username=%1\nset password=%2\nset STONAVM_ACT=on\nset STONAVM_RSP_PASS=on\nset MS_HW_pwdfile=MS_HW_pwdfile%random%\nset MS_HW_unitlist=MS_HW_unitlist%random%\nIF DEFINED STONAVM_HOME (\n\techo %password%> \"%STONAVM_HOME%\\%MS_HW_pwdfile%\"\n\t\"%STONAVM_HOME%\\auaccountenv\" -set -uid %username% -passwdfile \"%STONAVM_HOME%\\%MS_HW_pwdfile%\"\n\t\"%STONAVM_HOME%\\auunitref\" | more +1  | nawk.exe \"{print $1 }\" > \"%STONAVM_HOME%\\%MS_HW_unitlist%\"\n\tFOR /f \"usebackq tokens=*\" %%i IN (\"%STONAVM_HOME%\\%MS_HW_unitlist%\") DO (\n\t  echo %password%> \"%STONAVM_HOME%\\%MS_HW_pwdfile%\"\n\t  \"%STONAVM_HOME%\\auaccountenv\" -set -uid %username% -passwdfile \"%STONAVM_HOME%\\%MS_HW_pwdfile%\"\n    echo MS_HW_SYSTEM_START %%i\n\t\t\"%STONAVM_HOME%\\%3\" %4 %5 -unit %%i\n\t\techo MS_HW_SYSTEM_END %%i\n\t\t)\n\tdel /f \"%STONAVM_HOME%\\%MS_HW_unitlist%\"\n  \"%STONAVM_HOME%\\auaccountenv\" -rm\n\t)"
connector:
  displayName: Hitachi HDS AMS/HUS (SNM2 CLI on Windows)
  platforms: "Hitachi AMS,Hitachi HUS"
  reliesOn: Hitachi SNM2 CLI
  version: 1.0
  information: "This connector discovers the status of Hitachi AMS/HUS's Processors, CSW, Cache, SM, Power Supplies, Batteries, Fans, Physical Disks and Environment."
  detection:
    connectionTypes:
    - remote
    appliesTo:
    - Storage
    disableAutoDetection: true
    criteria:
      # Check we are running these commands locally on a Windows Server
      # WINDOWS ONLY
    - type: osCommand
      commandLine: echo %OS%
      errorMessage: Connector only works on a Windows NT Server
      expectedResult: Windows_NT
      executeLocally: true
      forceSerialization: true
      # STONAVM_HOME should be defined
      # WINDOWS ONLY
    - type: osCommand
      commandLine: IF DEFINED STONAVM_HOME ( echo STONAVM_HOME Defined )
      errorMessage: STONAVM_HOME is not defined
      expectedResult: STONAVM_HOME Defined
      executeLocally: true
      forceSerialization: true
      # We should be able to authenticate
      # WINDOWS ONLY
    - type: osCommand
      commandLine: "set STONAVM_RSP_PASS=on&& echo %{PASSWORD}> \"%STONAVM_HOME%\\MS_HW_pwdfile\" && \"%STONAVM_HOME%\\auaccountenv\" -set -uid %{USERNAME} -passwdfile \"%STONAVM_HOME%\\MS_HW_pwdfile\""
      errorMessage: SNM2 CLI is unable to authenticate.
      expectedResult: The account information has been set successfully
      executeLocally: true
      forceSerialization: true
