---
connector:
  displayName: HP Insight Management Agent - SCSI Storage
  platforms: HP ProLiant
  reliesOn: HP Insight Management Agents
  version: 1.0
  information: This connector monitors the HP/Compaq SCSI disk by connecting to the Storage Management SNMP sub-agent of the HP Insight Manager agent.
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - NT
    - Linux
    - OSF1
    - VMS
    - OOB
    - Solaris
    supersedes:
    - WBEMGenDiskNT
    - SmartMonLinux
    - SunRaidctl
    - SunIostat
    - SunIostatNonSun
    - SunTapeDrives
    criteria:
      # Exclude Windows, because on Windows, SCSI disks are monitored through
      # the WBEM layer
    - type: deviceType
      exclude:
      - NT
    - type: snmpGetNext
      oid: 1.3.6.1.4.1.232.5.2.4.1.1
monitors:
  disk_controller:
    discovery:
      sources:
        source(1):
          # Source(1) = the cpqScsiCntlrTable
          # ID;ControllerNumber;BusNumber;FWVers;BIOSVers;Model
          type: snmpTable
          oid: 1.3.6.1.4.1.232.5.2.2.1.1
          selectColumns: "ID,1,2,4,5,15"
          computes:
            # Concatenate ControllerNumber and BusNumber to obtain the ControllerIndex
            # ID;ControllerIndex;BusNumber;FWVers;BIOSVers;Model
          - type: rightConcat
            column: 2
            value: .
          - type: rightConcat
            column: 2
            value: Column(3)
        source(2):
          # Source(2) = the cpqScsiPhyDrv snmp table
          # We're going to keep only disk controllers that have disks attached to them
          # ID;ControllerNumber;BusNumber;Model;SizeMB;SerialNumber;Status
          type: snmpTable
          oid: 1.3.6.1.4.1.232.5.2.4.1.1
          selectColumns: "ID,1,2,4,7,30,9"
          computes:
            # Change the 4294967295 size value into an empty string
            # because this is not a real size
            # ID;ControllerNumber;BusNumber;Model;SizeMB;SerialNumber;Status
          - type: replace
            column: 5
            existingValue: 4294967295
            newValue: ""
            # Convert the size into bytes
            # ID;ControllerNumber;BusNumber;Model;Size;SerialNumber;Status
          - type: multiply
            column: 5
            value: 1048576
            # Concatenate ControllerNumber and BusNumber to obtain the ControllerIndex
            # ID;ControllerIndex;BusNumber;Model;Size;SerialNumber;Status
          - type: rightConcat
            column: 2
            value: .
          - type: rightConcat
            column: 2
            value: Column(3)
            # Remove disks that are marked as missing by Insight Manager
            # These disks shouldn't be discovered, that way they'll be marked
            # as "missing" by Hardware Sentry
          - type: excludeMatchingLines
            column: 6
            valueList: "6,7,9,11"
        source(3):
          # Source(3) = table joint of Source(1) and Source(2)
          # in order to keep only disk controllers with physical disks
          # ID;ControllerNumber;BusNumber;FWVers;BIOSVers;Model;ID;ControllerIndex;BusNumber;Model;Size;SerialNumber;Status
          type: tableJoin
          leftTable: $monitors.disk_controller.discovery.sources.source(1)$
          rightTable: $monitors.disk_controller.discovery.sources.source(2)$
          leftKeyColumn: 2
          rightKeyColumn: 2
      mapping:
        # The InstanceTable
        source: $monitors.disk_controller.discovery.sources.source(3)$
        attributes:
          id: $column(1)
          controller_number: $column(2)
          model: $column(6)
          firmware_version: $column(4)
          bios_version: $column(5)
          hw.parent.type: enclosure
          name: "sprintf(\"Disk Controller: %s (%s)\", $column(2), $column(6))"
    collect:
      # Collect type = "multi-instance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = the cpqScsiCntlrTable
          # ID;ControllerStatus
          type: snmpTable
          oid: 1.3.6.1.4.1.232.5.2.2.1.1
          selectColumns: "ID,7"
          computes:
            # Duplicate ControllerStatus
            # ID;ControllerStatus;ControllerStatus
          - type: duplicateColumn
            column: 2
            # Translate first ControllerStatus into a PATROL status
            # ID;Status;ControllerStatus
          - type: translate
            column: 2
            translationTable: DiskControllerStatusTranslationTable
            # Translate second ControllerStatus into a more readable string
            # ID;Status;statusInformation
          - type: translate
            column: 3
            translationTable: DiskControllerStatusInformationTranslationTable
      mapping:
        # ValueTable = source(1)
        source: $monitors.disk_controller.collect.sources.source(1)$
        deviceId: $column(1)
        metrics:
          hw.status{hw.type="disk_controller"}: $column(2)
        legacyTextParameters:
          StatusInformation: $column(3)
  physical_disk:
    discovery:
      mapping:
        # The instance table = DiskController.Discovery.Source(2)
        source: $monitors.disk_controller.discovery.sources.source(2)$
        attributes:
          id: $column(1)
          vendor: $column(4)
          serial_number: $column(6)
          hw.parent.type: disk_controller
          hw.parent.id: "lookup(\"disk_controller\", \"id\", \"controller_number\", $column(2))"
          name: "sprintf(\"%s (%s - %by10hf.s)\", $column(1), $column(4), $column(5))"
        metrics:
          hw.physical_disk.size: $column(5)
    collect:
      # Collect type is: multi-instance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = the cpqScsiPhyDrv snmp table
          # ID;status;
          type: snmpTable
          oid: 1.3.6.1.4.1.232.5.2.4.1.1
          selectColumns: "ID,9"
          computes:
            # Duplicate the status column, two times
            # ID;status;status;
          - type: duplicateColumn
            column: 2
          # ID;status;status;status
          - type: duplicateColumn
            column: 3
            # Translate the first status column into a PATROL status
            # ID;PATROLstatus;status;status
          - type: translate
            column: 2
            translationTable: PhysicalDiskStatusTranslationTable
            # Translate the second status column into a more readable string
            # ID;PATROLstatus;statusInformation;status
          - type: translate
            column: 3
            translationTable: PhysicalDiskStatusInformationTranslationTable
            # Translate the third status into a 0 (no failure predicted) or 1 (failure is predicted)
            # ID;PATROLstatus;statusInformation;predictFailureStatus
          - type: translate
            column: 4
            translationTable: PhysicalDiskSMARTStatusTranslationTable
      mapping:
        # The ValueTable = source(1)
        source: $monitors.physical_disk.collect.sources.source(1)$
        deviceId: $column(1)
        metrics:
          hw.status{hw.type="physical_disk"}: $column(2)
          hw.status{hw.type="physical_disk", state="predicted_failure"}: boolean($column(4))
        legacyTextParameters:
          StatusInformation: $column(3)
  logical_disk:
    discovery:
      sources:
        source(1):
          # Source(1) = the cpqScsiLogDrv snmp table
          # ID;ControllerNumber;BusNumber;FaultToleranceLevel;SizeMB
          type: snmpTable
          oid: 1.3.6.1.4.1.232.5.2.3.1.1
          selectColumns: "ID,1,2,4,6"
          computes:
            # Translate size into bytes
            # ID;ControllerNumber;BusNumber;FaultToleranceLevel;Size
          - type: multiply
            column: 5
            value: 1048576
            # Translate the FaultToleranceLevel into a more readable string
            # ID;ControllerNumber;BusNumber;RAIDLevel;Size
          - type: translate
            column: 4
            translationTable: RAIDLevelTranslationTable
            # Concatenate ControllerNumber and BusNumber to obtain the ControllerIndex
            # ID;ControllerIndex;BusNumber;RAIDLevel;Size
          - type: rightConcat
            column: 2
            value: .
          - type: rightConcat
            column: 2
            value: Column(3)
      mapping:
        # The InstanceTable
        source: $monitors.logical_disk.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          raid_level: $column(4)
          hw.parent.type: disk_controller
          hw.parent.id: "lookup(\"disk_controller\", \"id\", \"controller_number\", $column(2))"
          name: "sprintf(\"%s (%s - %by2hf.s)\", $column(1), $column(4), $column(5))"
        metrics:
          hw.logical_disk.limit: $column(5)
    collect:
      # Collect type = MultiInstance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = the cpqScsiLogDrv snmp table
          # ID;Status
          type: snmpTable
          oid: 1.3.6.1.4.1.232.3.2.3.1.1
          selectColumns: "ID,5"
          computes:
            # Duplicate the status column
            # ID;Status;Status
          - type: duplicateColumn
            column: 2
            # Translate the first status column into a PATROL status
            # ID;PATROLStatus;Status
          - type: translate
            column: 2
            translationTable: LogicalDiskStatusTranslationTable
            # Translate the second status column into a more readable string
            # ID;PATROLStatus;StatusInformation
          - type: translate
            column: 3
            translationTable: LogicalDiskStatusInformationTranslationTable
      mapping:
        # The ValueTable = source(1)
        source: $monitors.logical_disk.collect.sources.source(1)$
        deviceId: $column(1)
        metrics:
          hw.status{hw.type="logical_disk"}: $column(2)
        legacyTextParameters:
          StatusInformation: $column(3)
translations:
  DiskControllerStatusTranslationTable:
    "2": ok
    default: UNKNOWN
    "3": failed
  RAIDLevelTranslationTable:
    "2": 0
    default: ""
    "3": 1
    "4": 4
    "5": 5
    "6": 1E
  PhysicalDiskStatusInformationTranslationTable:
    "11": Missing
    "12": Hard error
    "2": ""
    default: Unknown Status
    "3": Failed
    "4": Not configured
    "5": Bad cable
    "6": Missing
    "7": Missing
    "8": Predicted failure
    "9": Missing
    "10": Offline
  DiskControllerStatusInformationTranslationTable:
    "2": ""
    default: Unknown Status
    "3": Failed
  PhysicalDiskSMARTStatusTranslationTable:
    "11": "TRUE"
    default: "FALSE"
    "6": "TRUE"
    "7": "TRUE"
    "9": "TRUE"
  LogicalDiskStatusInformationTranslationTable:
    "11": Disabled
    "2": ""
    default: Unknown Status
    "3": Failed
    "4": Unconfigured
    "5": Recovering
    "6": Ready for rebuild
    "7": Rebuilding
    "8": Wrong drive
    "9": Bad connect
    "10": Degraded
  LogicalDiskStatusTranslationTable:
    "11": degraded
    "2": ok
    default: UNKNOWN
    "3": failed
    "4": ok
    "5": degraded
    "6": ok
    "7": degraded
    "8": failed
    "9": failed
    "10": degraded
  PhysicalDiskStatusTranslationTable:
    "11": failed
    "12": failed
    "2": ok
    default: UNKNOWN
    "3": failed
    "4": degraded
    "5": failed
    "6": failed
    "7": failed
    "8": ok
    "9": failed
    "10": degraded
