---
connector:
  displayName: IBM AIX - usysfault
  platforms: IBM POWER
  reliesOn: IBM AIX usysfault command
  information: Provides the status of the System Attention LED of an IBM AIX server.
  version: 1.0
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - RS6000
    criteria:
    # OS should be AIX (whatever version)
    - type: deviceType
      keep:
      - RS6000
    # usysfault has to return either normal or fault
    - type: osCommand
      commandLine: "%{SUDO:/usr/lpp/diagnostics/bin/usysfault}/usr/lpp/diagnostics/bin/usysfault"
      expectedResult: ^\(normal\)\|\(fault\)$
sudoCommands:
- /usr/lpp/diagnostics/bin/usysfault
monitors:
  led:
    discovery:
      sources:
        source(1):
          # Source(1) = Static table: one line to create the instance corresponding to one LED: the System Attention LED
          # LEDID;Label;Color;OnStatus;BlinkingStatus;OffStatus;
          type: static
          value: SystemAttention;System Attention;Amber;ALARM;ALARM;OK;
      mapping:
        # The discovery table
        source: "${source::monitors.led.discovery.sources.source(1)}"
        attributes:
          id: $1
          __name: $2
          color: $3
          __on_status: $4
          __blinking_status: $5
          __off_status: $6
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"%s (%s - %s)\", $1, $3, $2)}"
    collect:
      # Collect type = mono-instance
      type: monoInstance
      sources:
        source(1):
          # Source(1) = /usr/lpp/diagnostics/bin/usysfault
          # ledStatus
          type: osCommand
          commandLine: /usr/lpp/diagnostics/bin/usysfault
          selectColumns: 1
          computes:
            # Translate the first status column into a PATROL status
            # ledStatus
          - type: translate
            column: 1
            translationTable: "${translation::LEDStatusTranslationTable}"
      mapping:
        # CollectTable = Source(1)
        source: "${source::monitors.led.collect.sources.source(1)}"
        metrics:
          hw.status{hw.type="led"}: legacyLedStatus($1)
translations:
  LEDStatusTranslationTable:
    normal: "Off"
    fault: "On"
    Default: "Off"
