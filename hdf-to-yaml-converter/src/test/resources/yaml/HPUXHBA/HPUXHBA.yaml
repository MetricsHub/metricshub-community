---
connector:
  displayName: HP-UX - HBA
  platforms: "HP 9000,HP Integrity,HP SuperDome"
  reliesOn: "HP UX system commands (ioscan, fcmsutil)"
  information: Provides hardware status information for the fiber channel HBA cards on HP UX systems.
  version: 1.0
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - HP
    supersedes:
    - CpqHBA
    - SMISHBA
    criteria:
    # Test the hbacmd command for ports
    - type: osCommand
      commandLine: "%{SUDO:/usr/sbin/ioscan} /usr/sbin/ioscan -fnC fc"
      expectedResult: /dev/
      timeout: 60
sudoCommands:
- /usr/sbin/ioscan
- /opt/fcms/bin/fcmsutil
monitors:
  network:
    discovery:
      sources:
        source(1):
          # Get the outputs of ioscan and fcmsutil for all ports using EmbeddedFile 1
          type: osCommand
          commandLine: /bin/sh $file("embeddedFile-1")$
          timeout: 90
          computes:
            # AWK the output to get the instance table
            # portID;device;description;path;speed;portWWN;remoteWWN;
          - type: awk
            script: $file("embeddedFile-2")$
            keep: ^MSHW;
            separators: ;
            selectColumns: "2,3,4,5,6,7,8"
      mapping:
        # The Instance Table
        # portID;device;description;path;speed;portWWN;remoteWWN;
        source: $monitors.network.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          model: $column(3)
          physical_address: $column(6)
          physical_address_type: WWN
          hw.parent.type: enclosure
          name: "sprintf(\"%s (%s)\", $column(1), $column(3))"
    collect:
      # Collect type is multi-instance
      type: monoInstance
      sources:
        source(1):
          # Source(1) = output of fcmsutil %hbaID%
          type: osCommand
          commandLine: "%{SUDO:/opt/fcms/bin/fcmsutil} /opt/fcms/bin/fcmsutil /dev/$network.id$"
          computes:
            # AWK the output to get the speed and status table
            # speed;status;
          - type: awk
            script: $file("embeddedFile-3")$
            keep: ^MSHW;
            separators: ;
            selectColumns: "2,3"
            # Duplicate Staus Column
            # Speed;Status;Status;Status;
          - type: duplicateColumn
            column: 2
          - type: duplicateColumn
            column: 2
            # Translate Network Status
            # Speed;PatrolStatus;Status;Status;
          - type: translate
            column: 2
            translationTable: NetworkStatusTranslationTable
            # Translate Network Status Information
            # Speed;PatrolStatus;StatusInformation;Status;WWN;
          - type: translate
            column: 3
            translationTable: NetworkStatusInfoTranslationTable
            # Translate Network Status Information
            # Speed;PatrolStatus;StatusInformation;LinkStatus;
          - type: translate
            column: 4
            translationTable: NetworkLinkStatusTranslationTable
      mapping:
        # Value table = Source(1)
        # Speed;PatrolStatus;StatusInformation;LinkStatus;
        source: $monitors.network.collect.sources.source(1)$
        metrics:
          hw.network.up: legacyLinkStatus($column(4))
          hw.network.bandwidth.limit: megaBit2Bit($column(1))
          hw.status{hw.type="network"}: $column(2)
        legacyTextParameters:
          StatusInformation: $column(3)
translations:
  NetworkStatusInfoTranslationTable:
    DISABLED: Disabled - The host bus adapter is not participating on the loop
    READY: ""
    AWAITING_LINK_UP: Waiting for the Fibre Channel link to come up.
    SUSPENDED: The driver has been suspended by the user.
    LOOPBACK_STATE: The host bus adapter is in the loop back test phase.
    RESETTING: The host bus adapter is being reset.
    Default: Unknown Status
    OFFLINE: Offline - The host bus adapter is not participating on the loop
    ONLINE: ""
  NetworkLinkStatusTranslationTable:
    READY: ok
    AWAITING_LINK_UP: degraded
    Default: UNKNOWN
    ONLINE: ok
  NetworkStatusTranslationTable:
    DISABLED: failed
    READY: ok
    AWAITING_LINK_UP: ok
    SUSPENDED: degraded
    LOOPBACK_STATE: failed
    RESETTING: degraded
    Default: UNKNOWN
    OFFLINE: failed
    ONLINE: ok
