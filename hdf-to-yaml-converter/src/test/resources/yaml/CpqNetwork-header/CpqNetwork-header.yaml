---
connector:
  detection:
    criteria:
    # Criteria(2): there must be something in the ifTable SNMP Table (NICs)
    - type: snmpGetNext
      oid: 1.3.6.1.4.1.232.18.2.3.1
monitors:
  network:
    discovery:
      sources:
        source(1):
          # Source(1) = cpqNicIfLogMapTable\nFull path:\tiso(1).org(3).dod(6).internet(1).private(4).enterprises(1).compaq(232).cpqNic(18).cpqNicComponent(2).cpqNicIfLogMap(2).cpqNicIfLogMapTable(1)\nID;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;\n\"ID,21,5,4,9,20,8,11,19\"
          type: snmpTable
          oid: 1.3.6.1.4.1.232.18.2.2.1.1
          selectColumns: "ID,21,5,4,9,20,8,11,19,21"
          computes:
            # Keep only real Team NICs
            # ID;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;
          - type: excludeMatchingLines
            column: 3
            valueList: ",0,1"
            # Add "VirtualInterface-" to the ID code in a readable string, so the Teaming is not removed
            # ID;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;
          - type: leftConcat
            column: 1
            value: VirtualInterface-
            # Add "DeviceType" Column (Virtual)
            # ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;
          - type: rightConcat
            column: 1
            value: ;Aggregate
            # Count Column Label
            # ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;
          - type: leftConcat
            column: 4
            value: "NICs Count: "
            # Translate the GroupType column content to a readable string
            # ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;
          - type: translate
            column: 5
            translationTable: "${translation::TeamNICSGroupTypeTranslationTable}"
            # GroupType Column Label
            # ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;
          - type: leftConcat
            column: 5
            value: "Type: "
            # Translate the SwitchoverMode column content to a readable string
            # ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;
          - type: translate
            column: 6
            translationTable: "${translation::TeamNICSSwitchoverModeTranslationTable}"
            # SwitchoverMode Column Label
            # ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;
          - type: leftConcat
            column: 6
            value: "Switch over Mode: "
            # Add an empty column (Location and PartNumber)
            # ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber
          - type: rightConcat
            column: 11
            value: ;;;
            # Add LinkStatus and Desactivate it for Virtual NetWorkCard
            # ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;LinkStatus;SpeedMbps;DisplayID;Location;PartNumber
          - type: rightConcat
            column: 9
            value: ;
        source(2):
          # Source(2) = cpqNicIfPhysAdapterEntry
          # ID;Role;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;
          # ID;3;4;14;36;39;31;32;10
          type: snmpTable
          oid: 1.3.6.1.4.1.232.18.2.3.1.1
          selectColumns: "ID,3,4,14,36,39,31,32,10"
          computes:
          # Replace Count and name by CountBlank and NameBlank in source(2) to match the same column number with the source(1)\nAdd \"DeviceType\" Column (Physical Adapter) as empty to match the same column number with the source(1)\nSource(1)\nID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber\nSource(2)\nTransform : ID;Role;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;\nTo : \t   ID;DeviceType;NameBlank;CountBlank;Role;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;
          - type: rightConcat
            column: 1
            value: ;Physical Adapter;;
          # Replace SwitchoverMode and IPV6Address by SwitchoverModeBlank and IPV6AddressBlank to match the same column number with the source(1)\nID;NameBlank;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;;SpeedMbps;DisplayID;\nSource(2)\nTransform : ID;DeviceType;NameBlank;CountBlank;Role;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;\nTo : \t   ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;SwitchoverModeBlank;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;
          - type: rightConcat
            column: 5
            value: ;;
            # Add the word Location
            # ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;SwitchoverModeBlank;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;
          - type: leftConcat
            column: 12
            value: "Location: "
            # Add the word PartNumber
            # ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;SwitchoverModeBlank;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;
          - type: leftConcat
            column: 13
            value: "Part Number: "
            # Translate the Role column content to a readable string
            # ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;SwitchoverModeBlank;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;
          - type: translate
            column: 5
            translationTable: "${translation::PhysicalAdapterRoleTranslationTable}"
            # Add the word Role
            # ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;IPV6AddressBlank;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;
          - type: leftConcat
            column: 5
            value: "Role: "
            # Add the word port
            # ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;IPV6AddressBlank;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;
          - type: leftConcat
            column: 14
            value: ' - Port '
            # Add Port in the DeviceType
            # ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;IPV6AddressBlank;MacAddress;Status;SpeedMbps;DisplayID;Location;PartNumber;Port;
          - type: rightConcat
            column: 2
            value: $14
            # Add LinkStatus and active it for Physical NetWorkCard
            # ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;IPV6AddressBlank;MacAddress;Status;LinkStatus;SpeedMbps;DisplayID;Location;PartNumber;Port;
          - type: rightConcat
            column: 9
            value: ;1
        source(3):
          # InstanceTable = constant source
          # source(1) ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;LinkStatus;SpeedMbps;DisplayID;
          # source(2) ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;IPV6AddressBlank;MacAddress;Status;LinkStatus;SpeedMbps;DisplayID;Location;PartNumber;Port;
          # Source(3) = Table union of Source(1) and Source(2)
          type: tableUnion
          tables:
          - "${source::monitors.network.discovery.sources.source(1)}"
          - "${source::monitors.network.discovery.sources.source(2)}"
      mapping:
        # source(1) ID;DeviceType;Name;Count;GroupType;SwitchoverMode;IPV6Address;MacAddress;Status;LinkStatus;SpeedMbps;DisplayID;
        # source(2) ID;DeviceType;NameBlank;CountBlank;Role;SwitchoverModeBlank;IPV6AddressBlank;MacAddress;Status;LinkStatus;SpeedMbps;DisplayID;Location;PartNumber;Port;
        source: Discovery_source
        attributes:
          id: $1
          __display_id: $12
          device_type: $2
          model: $3
          logical_address: $7
          logical_address_type: IP
          physical_address: $8
          physical_address_type: MAC
          info: "${awk::join(\" \", $5, $13, $14)}"
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"%s (%s - %s)\", $12, $2, $3)}"
        conditionalCollection:
          hw.network.up: legacyLinkStatus($10)
    collect:
      # Collect type is multi-instance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = cpqNicIfLogMapTable\nFull path:\tiso(1).org(3).dod(6).internet(1).private(4).enterprises(1).compaq(232).cpqNic(18).cpqNicComponent(2).cpqNicIfLogMap(2).cpqNicIfLogMapTable(1)\nID;Count;SpeedMbps;Status;Condition;\n\"ID,5,19,10,11\"
          type: snmpTable
          oid: 1.3.6.1.4.1.232.18.2.2.1.1
          selectColumns: "ID,5,19,11,10"
          computes:
            # Keep only real Team NICs: remove empty or 0 values
            # ID;Count;SpeedMbps;Status;Condition;
          - type: excludeMatchingLines
            column: 2
            regExp: \(^$\)\|\(^0$\)
            # Keep only real Team NICs: remove empty or 0 values
            # ID;SpeedMbps;Status;Condition;
          - type: keepColumns
            columnNumbers: "1,3,4,5"
            # Add "Virtual-" to the ID code in a readable string, so the Teaming is not considered as a duplicate !!!
            # ID;SpeedMbps;Status;Condition;
          - type: leftConcat
            column: 1
            value: VirtualInterface-
            # Translate the Condition column into a PATROLStatus
            # ID;SpeedMbps;Status;PATROLStatus;
          - type: translate
            column: 4
            translationTable: "${translation::TeamNICStatusTranslationTable}"
            # Translate the first Status column into a StatusInformation
            # ID;SpeedMbps;StatusInformation;PATROLStatus;
          - type: translate
            column: 3
            translationTable: "${translation::TeamNICStatusInformationTranslationTable}"
            # Translate the first Status column into a StatusInformation
            # ID;SpeedMbps;StatusInformation;PATROLStatus;RightConcat
          - type: duplicateColumn
            column: 4
        source(2):
          # Source(2) = cpqNicIfPhysAdapterTable
          # ID;SpeedMbps;Status;Condition;DuplexState;GoodTransmits;GoodReceives;BadTransmits;BadReceives;InOctets;OutOctets;
          type: snmpTable
          oid: 1.3.6.1.4.1.232.18.2.3.1.1
          selectColumns: "ID,36,14,12,11,16,17,18,19,37,38"
          computes:
            # Computes TotalError ( = BadTransmits + BadReceives )
            # ID;SpeedMbps;Status;Condition;DuplexState;GoodTransmits;GoodReceives;BadTransmits;BadReceives;InOctets;OutOctets;
          - type: add
            column: 8
            value: $9
            # ADD LinkStatus
            # ID;SpeedMbps;StatusInformation;Condition;LinkStatus;DuplexState;GoodTransmits;GoodReceives;TotalError;BadReceives;InOctets;OutOctets;
          - type: duplicateColumn
            column: 4
            # Translate LinkStatus to link Plug or Unplug
            # ID;SpeedMbps;StatusInformation;Condtion;LinkStatus;DuplexState;GoodTransmits;GoodReceives;TotalError;BadReceives;InOctets;OutOctets;
          - type: translate
            column: 5
            translationTable: "${translation::LinkStatusTranslationTable}"
            # Translate the Condition column into a PATROLStatus
            # ID;SpeedMbps;StatusInformation;PATROLStatus;LinkStatus;DuplexState;GoodTransmits;GoodReceives;TotalError;BadReceives;InOctets;OutOctets;
          - type: translate
            column: 4
            translationTable: "${translation::PhysicalAdapterStatusTranslationTable}"
            # Translate the first Status column into a StatusInformation
            # ID;SpeedMbps;StatusInformation;PATROLStatus;LinkStatus;DuplexState;GoodTransmits;GoodReceives;TotalError;BadReceives;InOctets;OutOctets;
          - type: translate
            column: 3
            translationTable: "${translation::PhysicalAdapterStatusInformationTranslationTable}"
            # Translate duplexState to correctly duplexMode
            # ID;SpeedMbps;StatusInformation;PATROLStatus;LinkStatus;DuplexState;GoodTransmits;GoodReceives;TotalError;BadReceives;InOctets;OutOctets;
          - type: translate
            column: 6
            translationTable: "${translation::DuplexModeTranslationTable}"
        source(3):
          # InstanceTable = constant source
          # source(1) ID;SpeedMbps;PATROLStatus;StatusInformation;
          # source(2) ID;SpeedMbps;StatusInformation;PATROLStatus;LinkStatus;DuplexState;GoodTransmits;GoodReceives;TotalError;BadReceives;InOctets;OutOctets;
          # Source(3) = Table union of Source(1) and Source(2)
          type: tableUnion
          tables:
          - "${source::monitors.network.collect.sources.source(1)}"
          - "${source::monitors.network.collect.sources.source(2)}"
      mapping:
        # ValueTable = Source(&)
        # source(1) ID;SpeedMbps;StatusInformation;PATROLStatus;
        # source(2) ID;SpeedMbps;StatusInformation;PATROLStatus;LinkStatus;DuplexState;GoodTransmits;GoodReceives;TotalError;BadReceives;InOctets;OutOctets;
        source: Collect_source
        deviceId: $1
        metrics:
          hw.network.bandwidth.limit: megaBit2Bit($2)
          hw.status{hw.type="network"}: $4
          hw.network.up: legacyLinkStatus($5)
          hw.network.full_duplex: legacyFullDuplex($6)
          hw.network.packets{direction="transmit"}: $7
          hw.network.packets{direction="receive"}: $8
          hw.errors{hw.type="network"}: $9
          hw.network.io{direction="receive"}: $11
          hw.network.io{direction="transmit"}: $12
        legacyTextParameters:
          StatusInformation: $3
translations:
  PhysicalAdapterRoleTranslationTable:
    "1": Unknow
    "2": Primary
    "255": Not Applicable
    "3": Secondary
    "4": Member
    "5": TxRx
    "6": Tx
    "7": Standby
    "8": None
    Default: Unknown
  PhysicalAdapterStatusInformationTranslationTable:
    "1": Unknown
    "2": ok
    "3": General Failure
    "4": Link Failure
    Default: Unknown
  TeamNICStatusInformationTranslationTable:
    "1": Unknown
    "2": ""
    "3": Primary Failed
    "4": Standby Failed
    "5": Group Failed
    "6": Redundancy Reduced
    "7": Redundancy Lost
    Default: Unknown
  DuplexModeTranslationTable:
    "1": 1
    "2": 0
    default: 1
    "3": 1
  LinkStatusTranslationTable:
    "1": ok
    "2": ok
    default: ok
    "3": ok
    "4": degraded
  PhysicalAdapterStatusTranslationTable:
    "1": UNKNOWN
    "2": ok
    "3": degraded
    "4": failed
    Default: UNKNOWN
  TeamNICStatusTranslationTable:
    "1": UNKNOWN
    "2": ok
    "3": degraded
    "4": failed
    Default: UNKNOWN
  TeamNICSSwitchoverModeTranslationTable:
    "1": Unknown
    "2": Not fault tolerant
    "3": Manual switch
    "4": Switch On Fail
    "5": Preferred Primary
    "6": Auto
    "7": Preference Order
    Default: Unknown
  TeamNICSGroupTypeTranslationTable:
    "11": Redundancy Set
    "1": Unknown
    "2": Not fault tolerant
    "3": Redundant Pair
    "4": Network Fault Tolerance
    "5": Adaptive Load Balancing
    "6": Fast EtherChannel
    "7": Gigabit EtherChannel
    "8": IEEE802.3ad Link Aggregation
    "9": Switch-assisted load balancing
    Default: Unknown
    "10": Transmit Load Balancing
