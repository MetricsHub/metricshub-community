---
connector:
  displayName: HP Insight Management Agent - IDE Storage
  platforms: HP ProLiant
  reliesOn: HP Insight Management Agents
  version: 1.0
  information: This connector monitors the HP/Compaq IDE Drive Arrays by connecting to the Storage Management SNMP sub-agent of the HP Insight Manager agent.
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - NT
    - Linux
    - OSF1
    - VMS
    - OOB
    - Solaris
    supersedes:
    - WBEMGenDiskNT
    - SmartMonLinux
    - SunRaidctl
    - SunIostat
    - SunIostatNonSun
    - SunTapeDrives
    criteria:
    - type: snmpGetNext
      oid: 1.3.6.1.4.1.232.14.2.4.1.1
monitors:
  disk_controller:
    discovery:
      sources:
        source(1):
          # Source(1) = the cpqIdeControllerTable
          # ID;ControllerIndex;Model;FWRev;
          type: snmpTable
          oid: 1.3.6.1.4.1.232.14.2.3.1.1
          selectColumns: "ID,1,3,4"
        source(2):
          # Source(2) = the cpqIdeAtaDiskTable snmp table
          # ControllerNumber
          type: snmpTable
          oid: 1.3.6.1.4.1.232.14.2.4.1.1
          selectColumns: 1
        source(3):
          # Source(3) = table joint of Source(1) with Source(2)
          # In order to keep only controllers that actually have disks attached to them
          type: tableJoin
          leftTable: "${source::monitors.disk_controller.discovery.sources.source(1)}"
          rightTable: "${source::monitors.disk_controller.discovery.sources.source(2)}"
          leftKeyColumn: 2
          rightKeyColumn: 1
      mapping:
        # The InstanceTable
        source: "${source::monitors.disk_controller.discovery.sources.source(3)}"
        attributes:
          id: $1
          controller_number: $2
          model: $3
          firmware_version: $4
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"Disk Controller: %s (%s)\", $2, $3)}"
  physical_disk:
    discovery:
      sources:
        source(1):
          # Source(1) = the cpqIdeAtaDiskTable snmp table
          # ID;ControllerNumber;Model;SerialNumber;SizeMB;ChannelCode;DiskNumberCode;OSName;
          type: snmpTable
          oid: 1.3.6.1.4.1.232.14.2.4.1.1
          selectColumns: "ID,1,3,5,8,11,12,15"
          computes:
            # Convert the size into bytes
            # ID;ControllerNumber;Model;SerialNumber;SizeBytes;ChannelCode;DiskNumberCode;OSName;
          - type: multiply
            column: 5
            value: 1048576
            # Convert the DIskNumberCode into a DiskLocation string
            # ID;ControllerNumber;Model;SerialNumber;SizeBytes;ChannelName;DiskNumberCode;OSName;
          - type: translate
            column: 7
            translationTable: "${translation::DiskNumberCodeTranslationTable}"
          - type: leftConcat
            column: 7
            value: "Location: "
      mapping:
        # The instance table = Source(1)
        source: "${source::monitors.physical_disk.discovery.sources.source(1)}"
        attributes:
          id: $1
          vendor: $3
          serial_number: $4
          info: $7
          hw.parent.type: disk_controller
          hw.parent.id: "lookup(\"disk_controller\", \"id\", \"controller_number\", $2)"
          name: "${awk::sprintf(\"%s (%s - %s)\", $1, $3, bytes2HumanFormatBase10($5))}"
        metrics:
          hw.physical_disk.size: $5
    collect:
      # Collect type is: multi-instance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = the cpqIdeAtaDiskTable snmp table
          # ID;status;
          type: snmpTable
          oid: 1.3.6.1.4.1.232.14.2.4.1.1
          selectColumns: "ID,6"
          computes:
            # Duplicate the status column
            # ID;status;status;
          - type: duplicateColumn
            column: 2
            # Duplicate again the status column
            # ID;status;status;status
          - type: duplicateColumn
            column: 3
            # Translate the first status column into a PATROL status
            # ID;PATROLstatus;status;status
          - type: translate
            column: 2
            translationTable: "${translation::PhysicalDiskStatusTranslationTable}"
            # Translate the second status column into a more readable string
            # ID;PATROLstatus;statusInformation;status
          - type: translate
            column: 3
            translationTable: "${translation::PhysicalDiskStatusInformationTranslationTable}"
            # Translate the third status into a 0 (no failure predicted) or 1 (failure is predicted)
            # ID;PATROLstatus;statusInformation;predictFailureStatus
          - type: translate
            column: 4
            translationTable: "${translation::PhysicalDiskSMARTStatusTranslationTable}"
      mapping:
        # The ValueTable = source(1)
        source: "${source::monitors.physical_disk.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.status{hw.type="physical_disk"}: $2
          hw.status{hw.type="physical_disk", state="predicted_failure"}: boolean($4)
        legacyTextParameters:
          StatusInformation: $3
  logical_disk:
    discovery:
      sources:
        source(1):
          # Source(1) = the cpqIdeLogicalDriveTable snmp table
          # ID;ControllerNumber;FaultToleranceLevel;SizeMB;OSName;
          type: snmpTable
          oid: 1.3.6.1.4.1.232.14.2.6.1.1
          selectColumns: "ID,1,3,4,11"
          computes:
            # Translate size into bytes
            # ID;ControllerNumber;FaultToleranceLevel;Size;OSName;
          - type: multiply
            column: 4
            value: 1048576
            # Translate the FaultToleranceLevel into a more readable string
            # ID;ControllerNumber;RAIDLevel;Size;OSName;
          - type: translate
            column: 3
            translationTable: "${translation::RAIDLevelTranslationTable}"
            # Add "Seen by the OS as " to the OS name column
            # ID;ControllerNumber;RAIDLevel;Size;OSName;
          - type: leftConcat
            column: 5
            value: 'Seen by the OS as '
      mapping:
        # The InstanceTable
        source: "${source::monitors.logical_disk.discovery.sources.source(1)}"
        attributes:
          id: $1
          raid_level: $3
          info: $5
          hw.parent.type: disk_controller
          hw.parent.id: "lookup(\"disk_controller\", \"id\", \"controller_number\", $2)"
          name: "${awk::sprintf(\"%s (%s - %s)\", $1, $3, bytes2HumanFormatBase2($4))}"
        metrics:
          hw.logical_disk.limit: $4
    collect:
      # Collect type = MultiInstance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = the cpqIdeLogicalDriveTable snmp table
          # ID;Status
          type: snmpTable
          oid: 1.3.6.1.4.1.232.14.2.6.1.1
          selectColumns: "ID,5"
          computes:
            # Duplicate the status column
            # ID;Status;Status
          - type: duplicateColumn
            column: 2
            # Translate the first status column into a PATROL status
            # ID;PATROLStatus;Status
          - type: translate
            column: 2
            translationTable: "${translation::LogicalDiskStatusTranslationTable}"
            # Translate the second status column into a more readable string
            # ID;PATROLStatus;StatusInformation
          - type: translate
            column: 3
            translationTable: "${translation::LogicalDiskStatusInformationTranslationTable}"
      mapping:
        # The ValueTable = source(1)
        source: "${source::monitors.logical_disk.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.status{hw.type="logical_disk"}: $2
        legacyTextParameters:
          StatusInformation: $3
translations:
  DiskNumberCodeTranslationTable:
    "11": SATA Device 7
    "22": Bay 2
    "23": Bay 3
    "24": Bay 4
    "25": Bay 5
    "26": Bay 6
    "27": Bay 7
    "28": Bay 8
    Default: ""
    "2": Device 0
    "3": Device 1
    "4": SATA Device 0
    "5": SATA Device 1
    "6": SATA Device 2
    "7": SATA Device 3
    "8": SATA Device 4
    "9": SATA Device 5
    "10": SATA Device 6
    "21": Bay 1
  RAIDLevelTranslationTable:
    "2": 0
    "3": 1
    "4": 0+1
    Default: ""
  PhysicalDiskStatusInformationTranslationTable:
    "2": ""
    "3": SMART predicted failure
    "4": Failed
    Default: Unknown Status
  PhysicalDiskSMARTStatusTranslationTable:
    "1": "FALSE"
    "2": "FALSE"
    "3": "TRUE"
    Default: "FALSE"
  LogicalDiskStatusInformationTranslationTable:
    "2": ""
    "3": Degraded
    "4": Rebuilding
    "5": Failed
    Default: Unknown Status
  LogicalDiskStatusTranslationTable:
    "2": ok
    "3": degraded
    "4": degraded
    "5": failed
    Default: UNKNOWN
  PhysicalDiskStatusTranslationTable:
    "2": ok
    "3": ok
    "4": failed
    Default: UNKNOWN
