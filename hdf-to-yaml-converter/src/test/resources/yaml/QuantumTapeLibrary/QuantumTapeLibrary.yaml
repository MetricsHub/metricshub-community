---
connector:
  displayName: Quantum (ADIC) based Tape Libraries
  platforms: Quantum (ADIC) Scalar Tape Library
  reliesOn: Quantum SNMP Agent (ADIC-TAPE-LIBRARY-MIB)
  version: 1.2
  information: Provides monitoring of Quantum Tape Libraries through the SNMP Agent (ADIC).
  detection:
    connectionTypes:
    - remote
    appliesTo:
    - Storage
    criteria:
      # DETECTION
      # Does a get_next to see if there that the model OID is populated.
    - type: snmpGetNext
      oid: 1.3.6.1.4.1.3764.1.10.10.1.6
monitors:
  enclosure:
    discovery:
      sources:
        source(1):
          # Source(1) = \ttapeLibrarySystem SNMP table\nVendor;SerialNumber;Model;Firmware Revision
          type: snmpTable
          oid: 1.3.6.1.4.1.3764.1.10.10.1
          selectColumns: "4,5,7,11"
      mapping:
        # InstanceTable = Source(1)
        source: "${source::monitors.enclosure.discovery.sources.source(1)}"
        attributes:
          id: Quantum Library
          vendor: $1
          model: $3
          serial_number: $2
          bios_version: $4
          type: Storage
          name: "${awk::sprintf(\"Storage: (%s %s)\", $1, $3)}"
    collect:
      type: multiInstance
      sources:
        source(1):
          type: snmpGet
          oid: 1.3.6.1.4.1.3764.1.10.10.1.8.0
          computes:
            # Duplicate status, because we will translate it two times
            # Status;Status;
          - type: duplicateColumn
            column: 1
            # Translate Status into PATROLStatus
            # PATROLStatus;Status;
          - type: translate
            column: 1
            translationTable: "${translation::StatusTranslationTable}"
            # Translate second Status into more readable string
            # PATROLStatus;StatusInformation;
          - type: translate
            column: 2
            translationTable: "${translation::StatusInformationTranslationTable}"
      mapping:
        source: "${source::monitors.enclosure.collect.sources.source(1)}"
        deviceId: Quantum Library
        metrics:
          hw.status{hw.type="enclosure"}: $1
        legacyTextParameters:
          StatusInformation: $2
  fan:
    discovery:
      sources:
        source(1):
          type: snmpGet
          oid: 1.3.6.1.4.1.3764.1.10.10.12.2.0
          computes:
            # Add the device ID
            # ID;Status
          - type: leftConcat
            column: 1
            value: Overall Cooling Status;
            #  Only keep Overall Cooling Status if there is a valid status
            # ID;Status
          - type: keepOnlyMatchingLines
            column: 2
            valueList: "1,2,3,4,5"
      mapping:
        # InstanceTable = Discovery.Source(1)
        # ID;Status
        source: "${source::monitors.fan.discovery.sources.source(1)}"
        attributes:
          sensor_location: Overall Cooling Status
          id: $1
          hw.parent.type: enclosure
          hw.parent.id: Quantum Library
          name: "${awk::sprintf(\"%s (%s)\", $1, \"Overall Cooling Status\")}"
    collect:
      type: multiInstance
      sources:
        source(1):
          type: snmpGet
          oid: 1.3.6.1.4.1.3764.1.10.10.12.2.0
          computes:
            # Duplicate status, because we will translate it two times
            # Status;Status;
          - type: duplicateColumn
            column: 1
            # Translate Status into PATROLStatus
            # PATROLStatus;Status;
          - type: translate
            column: 1
            translationTable: "${translation::StatusTranslationTable}"
            # Translate second Status into more readable string
            # PATROLStatus;StatusInformation;
          - type: translate
            column: 2
            translationTable: "${translation::StatusInformationTranslationTable}"
      mapping:
        source: "${source::monitors.fan.collect.sources.source(1)}"
        deviceId: Overall Cooling Status
        metrics:
          hw.status{hw.type="fan"}: $1
        legacyTextParameters:
          StatusInformation: $2
  power_supply:
    discovery:
      sources:
        source(1):
          type: snmpGet
          oid: 1.3.6.1.4.1.3764.1.10.10.12.1.0
          computes:
            # Add the device ID
            # ID;Status
          - type: leftConcat
            column: 1
            value: Overall Power Status;
            #  Only keep Overall Power Status if there is a valid status
            # ID;Status
          - type: keepOnlyMatchingLines
            column: 2
            valueList: "1,2,3,4,5"
      mapping:
        source: "${source::monitors.power_supply.discovery.sources.source(1)}"
        attributes:
          power_supply_type: Overall Power Status
          id: $1
          hw.parent.type: enclosure
          hw.parent.id: Quantum Library
          name: "${awk::sprintf(\"%s (%s)\", $1, \"Overall Power Status\")}"
    collect:
      type: multiInstance
      sources:
        source(1):
          type: snmpGet
          oid: 1.3.6.1.4.1.3764.1.10.10.12.1.0
          computes:
            # Duplicate status, because we will translate it two times
            # Status;Status;
          - type: duplicateColumn
            column: 1
            # Translate Status into PATROLStatus
            # PATROLStatus;Status;
          - type: translate
            column: 1
            translationTable: "${translation::StatusTranslationTable}"
            # Translate second Status into more readable string
            # PATROLStatus;StatusInformation;
          - type: translate
            column: 2
            translationTable: "${translation::StatusInformationTranslationTable}"
      mapping:
        source: "${source::monitors.power_supply.collect.sources.source(1)}"
        deviceId: Overall Power Status
        metrics:
          hw.status{hw.type="power_supply"}: $1
        legacyTextParameters:
          StatusInformation: $2
  disk_controller:
    discovery:
      sources:
        source(1):
          # Source(1) = \tscsiControllerEntry SNMP table\nID;scsiControllerFWRev;Status;
          type: snmpTable
          oid: 1.3.6.1.4.1.3764.1.10.10.15.2.1
          selectColumns: "ID,9,2"
        source(2):
          # Source(2) = \tsasPortEntry SNMP table\nID;scsiControllerFWRev;Status;
          type: snmpTable
          oid: 1.3.6.1.4.1.3764.1.10.10.15.3.1
          selectColumns: "ID,5,3"
        source(3):
          # Source(3) = Union of Source (1) and Source(2)
          # ID;scsiControllerFWRev;Status;
          type: tableUnion
          tables:
          - "${source::monitors.disk_controller.discovery.sources.source(1)}"
          - "${source::monitors.disk_controller.discovery.sources.source(2)}"
          computes:
            # Only Keep Disk Controllers with a Valid Status
            # ID;scsiControllerFWRev;Status;
          - type: keepOnlyMatchingLines
            column: 3
            valueList: "1,2,3,4,5"
      mapping:
        # InstanceTable = Source(1)
        # ID;scsiControllerFWRev;Status;
        source: "${source::monitors.disk_controller.discovery.sources.source(3)}"
        attributes:
          id: $1
          controller_number: $1
          firmware_version: $2
          hw.parent.type: enclosure
          hw.parent.id: Quantum Library
          name: "${awk::sprintf(\"Disk Controller: %s\", $1)}"
    collect:
      type: multiInstance
      sources:
        source(1):
          type: snmpTable
          oid: 1.3.6.1.4.1.3764.1.10.10.15.2.1
          selectColumns: "ID,2"
        source(2):
          type: snmpTable
          oid: 1.3.6.1.4.1.3764.1.10.10.15.3.1
          selectColumns: "ID,3"
        source(3):
          # Source(3) = Union of Source (1) and Source(2)
          # DeviceID;Status;
          type: tableUnion
          tables:
          - "${source::monitors.disk_controller.collect.sources.source(1)}"
          - "${source::monitors.disk_controller.collect.sources.source(2)}"
          computes:
            # Duplicate status, because we will translate it two times
            # Status;Status;
          - type: duplicateColumn
            column: 2
            # Translate Status into PATROLStatus
            # PATROLStatus;Status;
          - type: translate
            column: 2
            translationTable: "${translation::StatusTranslationTable}"
            # Translate second Status into more readable string
            # PATROLStatus;StatusInformation;
          - type: translate
            column: 3
            translationTable: "${translation::StatusInformationTranslationTable}"
      mapping:
        # Value Table
        source: "${source::monitors.disk_controller.collect.sources.source(3)}"
        deviceId: $1
        metrics:
          hw.status{hw.type="disk_controller"}: $2
        legacyTextParameters:
          StatusInformation: $3
  robotics:
    discovery:
      sources:
        source(1):
          type: snmpGet
          oid: 1.3.6.1.4.1.3764.1.10.10.12.5.0
          computes:
            # Add the device ID
            # ID;Status
          - type: leftConcat
            column: 1
            value: Overall Cassette Robotics Status;
            #  Only keep Overall Cassette Robot Status if there is a valid status
            # ID;Status
          - type: keepOnlyMatchingLines
            column: 2
            valueList: "1,2,3,4,5"
      mapping:
        # Instance Table
        # ID;Status
        source: "${source::monitors.robotics.discovery.sources.source(1)}"
        attributes:
          robotics_type: Overall Robotics Status
          id: $1
          hw.parent.type: enclosure
          hw.parent.id: Quantum Library
          name: "${awk::sprintf(\"%s (%s)\", $1, \"Overall Robotics Status\")}"
    collect:
      type: multiInstance
      sources:
        source(1):
          # Get the Robotics status
          type: snmpGet
          oid: 1.3.6.1.4.1.3764.1.10.10.12.5.0
          computes:
            # Duplicate status, because we will translate it two times
            # Status;Status;
          - type: duplicateColumn
            column: 1
            # Translate Status into PATROLStatus
            # deviceID;PATROLStatus;Status;
          - type: translate
            column: 1
            translationTable: "${translation::StatusTranslationTable}"
            # Translate second Status into more readable string
            # deviceID;PATROLStatus;StatusInformation;
          - type: translate
            column: 2
            translationTable: "${translation::StatusInformationTranslationTable}"
      mapping:
        # Value Table
        source: "${source::monitors.robotics.collect.sources.source(1)}"
        deviceId: Overall Cassette Robotics Status
        metrics:
          hw.status{hw.type="robotics"}: $1
        legacyTextParameters:
          StatusInformation: $2
  tape_drive:
    discovery:
      sources:
        source(1):
          # Source(1) = \tphysicalDriveEntry SNMP table\nphDriveSerialNumber;phDriveModel;phDriveVendor;phDriveLocation;
          type: snmpTable
          oid: 1.3.6.1.4.1.3764.1.10.10.11.3.1
          selectColumns: "17,3,4,6"
      mapping:
        # phDriveSerialNumber;phDriveModel;phDriveVendor;phDriveLocation;
        source: "${source::monitors.tape_drive.discovery.sources.source(1)}"
        attributes:
          id: $4
          vendor: $3
          model: $2
          serial_number: $1
          hw.parent.type: enclosure
          hw.parent.id: Quantum Library
          name: "${awk::sprintf(\"%s (%s %s)\", $4, $3, $2)}"
    collect:
      type: multiInstance
      sources:
        source(1):
          # Source(1) = \tphysicalDriveEntry SNMP table\nphDriveLocation;RAS Status;Cleaning Status;Loads
          type: snmpTable
          oid: 1.3.6.1.4.1.3764.1.10.10.11.3.1
          selectColumns: "6,11,12,16"
          computes:
            # Duplicate status, because we will translate it two times
            # phDriveLocation;Status;RAS Status;Cleaning Status;Loads
          - type: duplicateColumn
            column: 2
            # Translate Status into PATROLStatus
            # phDriveLocation;Patrol Status;RAS Status;Cleaning Status;Loads
          - type: translate
            column: 2
            translationTable: "${translation::StatusTranslationTable}"
            # Translate second Status into more readable string
            # deviceID;PATROLStatus;StatusInformation;Cleaning Status;Loads
          - type: translate
            column: 3
            translationTable: "${translation::StatusInformationTranslationTable}"
            # Duplicate Cleaning status, because we will translate it two times
            # deviceID;PATROLStatus;StatusInformation;Cleaning Status;Cleaning Status;Loads
          - type: duplicateColumn
            column: 4
            # Translate Status into PATROLStatus
            # deviceID;PATROLStatus;StatusInformation;Cleaning Status (0,1,2);Cleaning Status;Loads
          - type: translate
            column: 4
            translationTable: "${translation::CleaningStatusTranslationTable}"
            # Translate second Status into more readable string
            # deviceID;PATROLStatus;StatusInformation;Cleaning Status (0,1,2);Cleaning Status Information;Loads
          - type: translate
            column: 5
            translationTable: "${translation::CleaningStatusInformationTranslationTable}"
            # Merge Drive Status Information and Cleaning Status Information
            # deviceID;PATROLStatus;StatusInformation (incl cleaning);Cleaning Status (0,1,2);Cleaning Status Information;Loads
          - type: rightConcat
            column: 3
            value: $5
      mapping:
        # Value Table
        # deviceID;PATROLStatus;Status Information (incl cleaning);Cleaning Status (0,1,2);Cleaning Status Information;Loads
        source: "${source::monitors.tape_drive.collect.sources.source(1)}"
        deviceId: $1
        metrics:
          hw.status{hw.type="tape_drive"}: $2
          hw.status{hw.type="tape_drive", state="needs_cleaning"}: legacyNeedsCleaning($4)
          hw.tape_drive.operations{type="mount"}: $6
        legacyTextParameters:
          StatusInformation: $3
translations:
  CleaningStatusTranslationTable:
    "1": 1
    "2": 0
    "3": 2
    Default: UNKNOWN
  StatusInformationTranslationTable:
    "1": ""
    "2": Failed
    "3": Degraded
    "4": Warning
    "5": Informational
    "6": Unknown
    "7": Invalid
    Default: Unknown Status
  StatusTranslationTable:
    "1": ok
    "2": failed
    "3": degraded
    "4": degraded
    "5": degraded
    "6": UNKNOWN
    "7": failed
    Default: UNKNOWN
  CleaningStatusInformationTranslationTable:
    "1": ' Cleaning Required'
    "2": ""
    "3": ' Immediate Cleaning Required'
    Default: ' Unknown Cleaning Status'
