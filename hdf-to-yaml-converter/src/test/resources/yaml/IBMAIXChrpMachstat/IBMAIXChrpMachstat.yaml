---
connector:
  displayName: IBM AIX - CHRP Environment
  platforms: IBM POWER
  reliesOn: IBM AIX system commands (machstat)
  information: "Provides hardware environment information (temperature sensors, voltage sensors, fans, power supplies) on IBM CHRP-based AIX systems."
  version: 1.0
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - RS6000
    criteria:
    # OS should be HP (for HP-UX, whatever version)
    - type: deviceType
      keep:
      - RS6000
    # The various following tools have to be present
    - type: osCommand
      commandLine: "%{SUDO:/usr/sbin/bootinfo}/usr/sbin/bootinfo -p"
      expectedResult: ^chrp$
sudoCommands:
- /usr/sbin/bootinfo
- /usr/sbin/machstat
monitors:
  fan:
    discovery:
      sources:
        source(1):
          # Source(1) = static table of one row
          type: static
          value: SystemCooling;System Cooling;
      mapping:
        # Instance Table = Source(1)
        source: "${source::monitors.fan.discovery.sources.source(1)}"
        attributes:
          id: $1
          sensor_location: $2
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"%s (%s)\", $1, $2)}"
    collect:
      # Collect type = mono-instance
      type: monoInstance
      sources:
        source(1):
          # Source(1) = machstat -f
          # EPOW Event;
          type: osCommand
          commandLine: "%{SUDO:/usr/sbin/machstat}/usr/sbin/machstat -f"
          keep: "^[0-9] [0-9]"
          separators: ' '
          selectColumns: 1
          computes:
            # Duplicate the EPOW Event
            # EPOW Event;EPOW Event
          - type: duplicateColumn
            column: 1
            # Translate the first EPOW Event column into a PATROL Status
            # PATROLStatus;EPOW Event
          - type: translate
            column: 1
            translationTable: "${translation::FanStatusTranslationTable}"
            # Translate the second EPOW Event column into a more readable string
            # PATROLStatus;statusInformation
          - type: translate
            column: 2
            translationTable: "${translation::FanStatusInformationTranslationTable}"
      mapping:
        # ValueTable = Source(1) (easy enough)
        source: "${source::monitors.fan.collect.sources.source(1)}"
        metrics:
          hw.status{hw.type="fan"}: $1
        legacyTextParameters:
          StatusInformation: $2
  power_supply:
    discovery:
      sources:
        source(1):
          # Source(1) = static table of one row
          type: static
          value: SystemPower;System Power;
      mapping:
        # Instance Table = Source(1)
        source: "${source::monitors.power_supply.discovery.sources.source(1)}"
        attributes:
          id: $1
          power_supply_type: $2
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"%s (%s)\", $1, $2)}"
    collect:
      # Collect type = mono-instance
      type: monoInstance
      sources:
        source(1):
          # Source(1) = machstat -f
          # EPOW Event;
          type: osCommand
          commandLine: "%{SUDO:/usr/sbin/machstat}/usr/sbin/machstat -f"
          keep: "^[0-9] [0-9]"
          separators: ' '
          selectColumns: 1
          computes:
            # Duplicate the EPOW Event
            # EPOW Event;EPOW Event
          - type: duplicateColumn
            column: 1
            # Translate the first EPOW Event column into a PATROL Status
            # PATROLStatus;EPOW Event
          - type: translate
            column: 1
            translationTable: "${translation::PowerSupplyStatusTranslationTable}"
            # Translate the second EPOW Event column into a more readable string
            # PATROLStatus;statusInformation
          - type: translate
            column: 2
            translationTable: "${translation::PowerSupplyStatusInformationTranslationTable}"
      mapping:
        # ValueTable = Source(1) (easy enough)
        source: "${source::monitors.power_supply.collect.sources.source(1)}"
        metrics:
          hw.status{hw.type="power_supply"}: $1
        legacyTextParameters:
          StatusInformation: $2
translations:
  FanStatusTranslationTable:
    "1": degraded
    Default: ok
  PowerSupplyStatusTranslationTable:
    "0": ok
    "1": ok
    "2": degraded
    "3": failed
    "4": failed
    "5": failed
    "7": failed
    Default: UNKNOWN
  FanStatusInformationTranslationTable:
    "1": Non-critical Cooling Problem
    Default: ""
  PowerSupplyStatusInformationTranslationTable:
    "0": ""
    "1": ""
    "2": Non-critical Power Problem
    "3": Severe Power Problem - Shutting down!
    "4": Critical Problem - Halting now!
    "5": Critical Problem
    "7": Critical Problem
    Default: Unknown Status
