---
connector:
  displayName: HP Insight Management Agent - iLO
  platforms: HP ProLiant
  reliesOn: HP Insight Management Agents
  version: 1.0
  information: "This connector provides hardware monitoring of the HP iLO card in HP ProLiant servers through the HP Insight Manager (Server Agent) which supports almost all HP ProLiant and Integrity servers under Windows and Linux, as well as Tru64 servers."
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - NT
    - Linux
    - VMS
    - OSF1
    - OOB
    - Solaris
    criteria:
    # Check whether we have something in the CpqSm2 MIB
    - type: snmpGetNext
      oid: 1.3.6.1.4.1.232.9.2.2.17
monitors:
  other_device:
    discovery:
      sources:
        source(1):
          # Source(1) = the cpqSm2Cntlr quasi-SNMP table
          # ID;ModelCode
          type: snmpTable
          oid: 1.3.6.1.4.1.232.9.2.2
          selectColumns: "ID,21"
          computes:
            # Translate modelCode into model string
            # ID;Model
          - type: translate
            column: 2
            translationTable: "${translation::iLoModelTranslationTable}"
      mapping:
        # Instance Table
        source: "${source::monitors.other_device.discovery.sources.source(1)}"
        attributes:
          id: $1
          device_type: Management Card
          additional_label: $2
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"%s: %s (%s)\", \"Management Card\", $1, $2)}"
    collect:
      # Collect is multi-instance (all instances in one shot)
      type: multiInstance
      keys:
      - id
      sources:
        source(1):
          # Source(1) = the cpqSm2Cntlr quasi-SNMP table
          # ID;Status
          type: snmpTable
          oid: 1.3.6.1.4.1.232.9.2.2
          selectColumns: "ID,17"
          computes:
            # Duplicate the status column
            # ID;Status;Status
          - type: duplicateColumn
            column: 2
            # Translate Status into PATROLStatus
            # ID;PATROLStatus;Status
          - type: translate
            column: 2
            translationTable: "${translation::iLoStatusTranslationTable}"
            # Translate second Status into more readable string
            # ID;PATROLStatus;StatusInformation;PredictsFailure
          - type: translate
            column: 3
            translationTable: "${translation::iLoStatusInformationTranslationTable}"
      mapping:
        # ValueTable = Source(1)
        source: "${source::monitors.other_device.collect.sources.source(1)}"
        attributes:
          id: $1
        metrics:
          hw.status{hw.type="other_device"}: $2
        legacyTextParameters:
          StatusInformation: $3
  network:
    discovery:
      sources:
        source(1):
          # Source(1) = the cpqSm2NicConfig SNMP table
          # ID;Model;MacAddress;ipAddress;Enabled;Speed
          type: snmpTable
          oid: 1.3.6.1.4.1.232.9.2.5.1.1
          selectColumns: "ID,2,4,5,7,9"
          computes:
            # Filter out disabled network cards
            # ID;Model;MacAddress;ipAddress;Enabled;Speed
          - type: excludeMatchingLines
            column: 5
            valueList: 3
            # Add "Management Card - " to the model, so that the user doesn't get confused
            # between the "real" NICs and the one here used only for the management
            # ID;Model;MacAddress;ipAddress;Enabled;Speed
          - type: leftConcat
            column: 2
            value: 'Management Card - '
      mapping:
        # InstanceTable = Source(1)
        source: "${source::monitors.network.discovery.sources.source(1)}"
        attributes:
          id: $1
          model: $2
          physical_address: $3
          physical_address_type: MAC
          logical_address: $4
          logical_address_type: IP
          bandwidth: $6
          hw.parent.type: enclosure
          name: "${awk::sprintf(\"%s (%s)\", $1, $2)}"
    collect:
      # Collect type is "multi-instance
      type: multiInstance
      keys:
      - id
      sources:
        source(1):
          # Source(1) = the cpqSm2NicConfig SNMP table
          # ID;Condition
          type: snmpTable
          oid: 1.3.6.1.4.1.232.9.2.5.1.1
          selectColumns: "ID,11"
          computes:
            # Duplicate Condition
            # ID;Condition;Condition
          - type: duplicateColumn
            column: 2
            # Translate first Condition into PATROLStatus
            # ID;PATROLStatus;Condition
          - type: translate
            column: 2
            translationTable: "${translation::NetworkCardStatusTranslationTable}"
            # Translate second Condition into a more readable string
            # ID;PATROLStatus;statusInformation
          - type: translate
            column: 3
            translationTable: "${translation::NetworkCardStatusInformationTranslationTable}"
      mapping:
        # ValueTable = Source(1)
        source: "${source::monitors.network.collect.sources.source(1)}"
        attributes:
          id: $1
        metrics:
          hw.status{hw.type="network"}: $2
        legacyTextParameters:
          StatusInformation: $3
translations:
  NetworkCardStatusInformationTranslationTable:
    "2": ""
    "3": Degraded
    "4": Failed
    Default: Unknown Status
  iLoStatusInformationTranslationTable:
    "2": ""
    "3": Not Responding
    Default: Unknown Status
  iLoStatusTranslationTable:
    "2": ok
    "3": degraded
    Default: UNKNOWN
  NetworkCardStatusTranslationTable:
    "2": ok
    "3": degraded
    "4": failed
    Default: UNKNOWN
  iLoModelTranslationTable:
    "2": EISA Remote Insight
    "3": PCI Remote Insight
    "4": Remote Insight Lights-Out
    "5": Integrated Remote Insight Lights-Out
    "6": Remote Insight Lights-Out version II
    Default: Unknown Remote/Integrated Insight Lights-Out
