---
connector:
  displayName: Eaton PDU (SNMP)
  platforms: Eaton PDU
  reliesOn: PDU SNMP Enabled
  version: 1.0
  information: "This connector provides hardware monitoring through Eaton PDU SNMP interface. Data gathered includes temperature, inlet/outlet voltages, and power consumption."
  detection:
    connectionTypes:
    - remote
    appliesTo:
    - OOB
    criteria:
    - type: snmpGet
      oid: 1.3.6.1.4.1.534.6.6.7.1.2.1.3.0
      expectedResult: .
monitors:
  enclosure:
    discovery:
      sources:
        source(1):
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.1.2.1
          selectColumns: "3,4,5,6"
          computes:
          - type: leftConcat
            column: 3
            value: "Firmware Version: "
      mapping:
        source: "${source::monitors.enclosure.discovery.sources.source(1)}"
        attributes:
          id: $4
          vendor: Eaton
          model: $1
          serial_number: $2
          type: PDU
          info: $3
          name: "${awk::sprintf(\"Enclosure: (%s %s)\", \"Eaton\", $1)}"
    collect:
      type: monoInstance
      sources:
        source(1):
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.1.2.1
          selectColumns: "6,31,31"
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
          - type: translate
            column: 3
            translationTable: "${translation::statusTranslationTable}"
          - type: translate
            column: 4
            translationTable: "${translation::statusInformationTranslationTable}"
        source(2):
          type: snmpGet
          oid: 1.3.6.1.4.1.534.6.6.7.3.4.1.4.0.1.1
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
        source(3):
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.6.5.1
          selectColumns: 3
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
        source(4):
          type: tableJoin
          leftTable: "${source::monitors.enclosure.collect.sources.source(2)}"
          rightTable: "${source::monitors.enclosure.collect.sources.source(3)}"
          leftKeyColumn: 1
          rightKeyColumn: 1
          defaultRightLine: MSHW;;
          computes:
          - type: awk
            script: "${file::embeddedFile-1}"
        source(5):
          type: tableJoin
          leftTable: "${source::monitors.enclosure.collect.sources.source(1)}"
          rightTable: "${source::monitors.enclosure.collect.sources.source(4)}"
          leftKeyColumn: 1
          rightKeyColumn: 1
      mapping:
        source: "${source::monitors.enclosure.collect.sources.source(5)}"
        attributes:
          id: $2
        metrics:
          hw.status{hw.type="enclosure"}: $3
          hw.enclosure.power: $6
          hw.enclosure.energy: fakeCounter($6)
        legacyTextParameters:
          StatusInformation: $4
  temperature:
    discovery:
      sources:
        source(1):
          type: snmpGet
          oid: 1.3.6.1.4.1.534.6.6.7.1.2.1.6.0
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
        source(2):
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.7.1.1
          selectColumns: "2,8,9"
          computes:
          - type: divide
            column: 2
            value: 10
          - type: divide
            column: 3
            value: 10
          - type: leftConcat
            column: 1
            value: MSHW;
          - type: keepOnlyMatchingLines
            column: 2
            regExp: .
        source(3):
          type: tableJoin
          leftTable: "${source::monitors.temperature.discovery.sources.source(1)}"
          rightTable: "${source::monitors.temperature.discovery.sources.source(2)}"
          leftKeyColumn: 1
          rightKeyColumn: 1
      mapping:
        source: "${source::monitors.temperature.discovery.sources.source(3)}"
        attributes:
          id: $4
          __display_id: $4
          sensor_location: enclosure
          hw.parent.type: enclosure
          hw.parent.id: $2
          name: "${awk::sprintf(\"%s (%s)\", $4, \"enclosure\")}"
        metrics:
          hw.temperature.limit{limit_type="high.degraded"}: $5
          hw.temperature.limit{limit_type="high.critical"}: $6
    collect:
      type: monoInstance
      sources:
        source(1):
          # Source(1) = ID; temperature
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.7.1.1
          selectColumns: "2,4"
          computes:
          - type: divide
            column: 2
            value: 10
      mapping:
        source: "${source::monitors.temperature.collect.sources.source(1)}"
        attributes:
          id: $1
        metrics:
          hw.temperature: $2
  voltage:
    discovery:
      sources:
        source(1):
          type: snmpGet
          oid: 1.3.6.1.4.1.534.6.6.7.1.2.1.6.0
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
        source(2):
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.3.2.1
          selectColumns: "6,8"
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
          - type: keepOnlyMatchingLines
            column: 2
            regExp: .
        source(3):
          type: tableJoin
          leftTable: "${source::monitors.voltage.discovery.sources.source(1)}"
          rightTable: "${source::monitors.voltage.discovery.sources.source(2)}"
          leftKeyColumn: 1
          rightKeyColumn: 1
          defaultRightLine: MSHW;;
        source(4):
          type: copy
          from: "${source::monitors.voltage.discovery.sources.source(3)}"
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;Inlet;
        source(5):
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.6.1.1
          selectColumns: 3
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
        source(6):
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.6.3.1
          selectColumns: 2
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
        source(7):
          type: tableJoin
          leftTable: "${source::monitors.voltage.discovery.sources.source(5)}"
          rightTable: "${source::monitors.voltage.discovery.sources.source(3)}"
          leftKeyColumn: 1
          rightKeyColumn: 1
        source(8):
          type: tableJoin
          leftTable: "${source::monitors.voltage.discovery.sources.source(5)}"
          rightTable: "${source::monitors.voltage.discovery.sources.source(6)}"
          leftKeyColumn: 1
          rightKeyColumn: 1
        source(9):
          type: tableUnion
          tables:
          - "${source::monitors.voltage.discovery.sources.source(4)}"
          - "${source::monitors.voltage.discovery.sources.source(8)}"
      mapping:
        source: "${source::monitors.voltage.discovery.sources.source(9)}"
        attributes:
          id: $2
          __display_id: $2
          hw.parent.type: enclosure
          hw.parent.id: $4
          name: $2
        metrics:
          hw.voltage.limit{limit_type="low.critical"}: $6
          hw.voltage.limit{limit_type="high.degraded"}: $7
    collect:
      type: multiInstance
      keys:
      - id
      sources:
        source(1):
          type: snmpGet
          oid: 1.3.6.1.4.1.534.6.6.7.3.2.1.3.0.1.1
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;Inlet;MSHW;
        source(2):
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.6.1.1
          selectColumns: 3
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
        source(3):
          type: snmpTable
          oid: 1.3.6.1.4.1.534.6.6.7.6.1.1
          selectColumns: 2
          computes:
          - type: leftConcat
            column: 1
            value: MSHW;
        source(4):
          type: tableJoin
          leftTable: "${source::monitors.voltage.discovery.sources.source(2)}"
          rightTable: "${source::monitors.voltage.discovery.sources.source(3)}"
          leftKeyColumn: 1
          rightKeyColumn: 1
        source(5):
          type: tableUnion
          tables:
          - "${source::monitors.voltage.collect.sources.source(1)}"
          - "${source::monitors.voltage.collect.sources.source(4)}"
      mapping:
        source: "${source::monitors.voltage.collect.sources.source(5)}"
        attributes:
          id: $2
        metrics:
          hw.voltage: $4
translations:
  statusInformationTranslationTable:
    "0": Good
    "1": Internal Failure
  statusTranslationTable:
    "0": ok
    "1": failed
