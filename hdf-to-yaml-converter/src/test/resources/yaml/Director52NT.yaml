---
connector:
  displayName: IBM Director Agent 5.20.x - Windows
  platforms: IBM xSeries
  reliesOn: IBM Director Agent 5.20.x
  version: 1.1
  information: This connector provides hardware monitoring through the IBM Director Agent version 5.20.x which supports almost all IBM Netfinity and xSeries servers.
  detection:
    connectionTypes:
    - remote
    - local
    appliesTo:
    - NT
    supersedes:
    - IpmiTool
    criteria:
    # OS must be Windows
    - type: deviceType
      keep:
      - NT
    # Verify that the root/ibmsd WBEM namespace actually exists
    - type: wmi
      namespace: root
      query: SELECT Name FROM __NAMESPACE
      expectedResult: ^ibmsd;*$
    # The IBM Director Agent must be in version 5.x
    - type: wmi
      query: SELECT Version FROM IBMPSG_DirectorAgent
      namespace: root\ibmsd
      expectedResult: ^5\.2.*
    # The IBMPSG_ComputerSystemDetails WBEM class must be instanciated
    - type: wmi
      query: SELECT ProductName FROM IBMPSG_ComputerSystemDetails
      namespace: root\ibmsd
      errorMessage: The IBM Director Agent seems to not be working properly. Please reinstall the IBM Director Agent.
monitors:
  enclosure:
    discovery:
      sources:
        source(1):
          # Source(1) = the IBMPSG_ComputerSystemDetails WBEM class
          type: wmi
          query: "SELECT Model,ProductName,SerialNumber FROM IBMPSG_ComputerSystemDetails"
          namespace: root\ibmsd
          computes:
          # Concatenate ProductName and Name
          - type: rightConcat
            column: 2
            value: ' ('
          - type: rightConcat
            column: 2
            value: Column(1)
          - type: rightConcat
            column: 2
            value: )
      mapping:
        # InstanceTable = Source(1)
        # Note: InstanceTable must contain only one line!
        source: $monitors.enclosure.discovery.sources.source(1)$
        attributes:
          id: DIR5
          vendor: IBM
          model: $column(2)
          serial_number: $column(3)
          type: Computer
          name: "sprintf(\"Computer: (%s %s)\", \"IBM\", $column(2))"
    collect:
      type: monoInstance
      sources:
        source(1):
          # Source(1) = The IBMPSG_SystemEnclosure WBEM class
          type: wmi
          query: "SELECT IntrusionStatus,Tag FROM IBMPSG_SystemEnclosure"
          namespace: root\ibmsd
          computes:
          - type: keepOnlyMatchingLines
            column: 2
            regExp: 0$
          - type: translate
            column: 1
            translationTable: enclosureIntrusionStatusTranslationTable
      mapping:
        source: $monitors.enclosure.collect.sources.source(1)$
        metrics:
          hw.status{hw.type="enclosure", state="open"}: legacyIntrusionStatus($column(1))
  cpu:
    discovery:
      sources:
        source(1):
          type: wmi
          query: "SELECT CurrentClockSpeed,DeviceID,Manufacturer,Name FROM IBMPSG_Processor"
          namespace: root\ibmsd
      mapping:
        # InstanceTable = Source(1)
        source: $monitors.cpu.discovery.sources.source(1)$
        attributes:
          id: $column(2)
          vendor: $column(3)
          model: $column(4)
          hw.parent.type: enclosure
          hw.parent.id: DIR5
          name: "sprintf(\"%s (%s - %s - %mhhf.s)\", $column(2), $column(3), $column(4), $column(1))"
        metrics:
          hw.cpu.speed.limit{limit_type="max"}: megaHertz2Hertz($column(1))
    collect:
      type: multiInstance
      sources:
        source(1):
          # Source(1) = The IBMPSG_Processor WBEM class
          type: wmi
          query: "SELECT CPUStatus,DeviceID FROM IBMPSG_Processor"
          namespace: root\ibmsd
          computes:
          - type: duplicateColumn
            column: 1
          - type: translate
            column: 1
            translationTable: cpuStatusTranslationTable
          - type: translate
            column: 2
            translationTable: cpuStatusInformationTranslationTable
      mapping:
        source: $monitors.cpu.collect.sources.source(1)$
        deviceId: $column(3)
        metrics:
          hw.status{hw.type="cpu"}: $column(1)
        legacyTextParameters:
          StatusInformation: $column(2)
  memory:
    discovery:
      sources:
        source(1):
          # Source(1)
          type: wmi
          query: "SELECT Capacity,Manufacturer,SerialNumber,Tag,TypeDetail FROM IBMPSG_PhysicalMemory"
          namespace: root\ibmsd
          computes:
          # Convert size to MB
          - type: divide
            column: 1
            value: 1048576
          # Translate memory type
          - type: perBitTranslation
            column: 5
            bitList: "1,2,3,4,5,6,7,8,9,10,11,12,13"
            translationTable: MemoryBitTranslationTable
      mapping:
        # InstanceTable = Source(1)
        source: $monitors.memory.discovery.sources.source(1)$
        attributes:
          id: $column(4)
          vendor: $column(2)
          serial_number: $column(3)
          type: $column(5)
          hw.parent.type: enclosure
          hw.parent.id: DIR5
          name: "sprintf(\"%s (%s - %s - %s MB)\", $column(4), $column(2), $column(5), $column(1))"
        metrics:
          hw.memory.limit: mebiByte2Byte($column(1))
    collect:
      type: multiInstance
      sources:
        source(1):
          # Source(1) = The IBMPSG_Processor WBEM class
          type: wmi
          query: "SELECT HasError,Tag FROM IBMPSG_PhysicalMemory"
          namespace: root\ibmsd
          computes:
          - type: translate
            column: 1
            translationTable: memoryStatusTranslationTable
      mapping:
        source: $monitors.memory.collect.sources.source(1)$
        deviceId: $column(2)
        metrics:
          hw.status{hw.type="memory"}: $column(1)
  fan:
    discovery:
      sources:
        source(1):
          # Source(1) = the IBMPSG_Tachometer WBEM class
          type: wmi
          query: "SELECT DeviceID, FanType, UpperThresholdCritical FROM IBMPSG_Tachometer"
          namespace: root\ibmsd
          computes:
          - type: translate
            column: 2
            translationTable: FanTypeTranslationTable
      mapping:
        # InstanceTable = Source(1)
        source: $monitors.fan.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          sensor_location: $column(2)
          hw.parent.type: enclosure
          hw.parent.id: DIR5
          name: "sprintf(\"%s (%s)\", $column(1), $column(2))"
        metrics:
          hw.fan.speed.limit{limit_type="low.degraded"}: $column(3)
          hw.fan.speed.limit{limit_type="low.critical"}: 0
    collect:
      # The collect (as all WBEM-based collects) is "MultiInstance
      type: multiInstance
      sources:
        source(1):
          # Source(1) = The IBMPSG_Tachometer WBEM class
          type: wmi
          query: "SELECT CurrentReading,DeviceID FROM IBMPSG_Tachometer"
          namespace: root\ibmsd
      mapping:
        # ValueTable = Source(1)
        source: $monitors.fan.collect.sources.source(1)$
        deviceId: $column(2)
        metrics:
          hw.fan.speed: $column(1)
  temperature:
    discovery:
      sources:
        source(1):
          # Source(1) = The IBMPSG_TemperatureSensor WBEM class
          type: wmi
          query: "SELECT DeviceID, LowerThresholdCritical, LowerThresholdNonCritical, TempLocation FROM IBMPSG_TemperatureSensor"
          namespace: root\ibmsd
          computes:
          - type: translate
            column: 4
            translationTable: TemperatureTypeTranslationTable
      mapping:
        # InstanceTable = Source(1)
        source: $monitors.temperature.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          sensor_location: $column(4)
          hw.parent.type: enclosure
          hw.parent.id: DIR5
          name: "sprintf(\"%s (%s)\", $column(1), $column(4))"
        metrics:
          hw.temperature.limit{limit_type="high.degraded"}: $column(3)
          hw.temperature.limit{limit_type="high.critical"}: $column(2)
    collect:
      # Like all WBEM collects, this one is \"MultiInstance\"
      type: multiInstance
      sources:
        source(1):
          # Source(1) = the IBMPSG_TemperatureSensor WBEM class
          type: wmi
          query: "SELECT CurrentReading,DeviceID FROM IBMPSG_TemperatureSensor"
          namespace: root\ibmsd
      mapping:
        # ValueTable = Source(1)
        source: $monitors.temperature.collect.sources.source(1)$
        deviceId: $column(2)
        metrics:
          hw.temperature: $column(1)
  voltage:
    discovery:
      sources:
        source(1):
          # Source(1) = all the instances of the IBMPSG_VoltageSensor class
          type: wmi
          query: "SELECT DeviceID,LowerThresholdNonCritical,UpperThresholdNonCritical,VoltageType FROM IBMPSG_VoltageSensor"
          namespace: root\ibmsd
          computes:
          # Translate the voltage type into a more readable string
          - type: translate
            column: 4
            translationTable: VoltageTypeTranslationTable
            # Thresholds for voltages are sometimes reported as "0" by the agent.  Replacing these "0" by no value to prevent incorrect thresholds.
            # Add a MSHW_ string to our value and then remove MSHW_0. This should remove a 0 value and only that value
          - type: leftConcat
            column: 2
            value: MSHW_
          - type: leftConcat
            column: 3
            value: MSHW_
          # Remove 0 value
          - type: replace
            column: 2
            existingValue: MSHW_0
            newValue: ""
          - type: replace
            column: 3
            existingValue: MSHW_0
            newValue: ""
          # Remove MSHW_ for non 0 values
          - type: replace
            column: 2
            existingValue: MSHW_
            newValue: ""
          - type: replace
            column: 3
            existingValue: MSHW_
            newValue: ""
      mapping:
        # Here is the instance table = source(1)
        source: $monitors.voltage.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          sensor_location: $column(4)
          hw.parent.type: enclosure
          hw.parent.id: DIR5
          name: "sprintf(\"%s (%s)\", $column(1), $column(4))"
        metrics:
          hw.voltage.limit{limit_type="high.degraded"}: $column(3)
          hw.voltage.limit{limit_type="low.critical"}: $column(2)
    collect:
      # It's a "MultiInstance" collect
      type: multiInstance
      sources:
        source(1):
          # Source(1) = the IBMPSG_VoltageSensor class
          type: wmi
          query: "SELECT CurrentReading,DeviceID FROM IBMPSG_VoltageSensor"
          namespace: root\ibmsd
      mapping:
        # ValueTable = Source(1)
        source: $monitors.voltage.collect.sources.source(1)$
        deviceId: $column(2)
        metrics:
          hw.voltage: $column(1)
  power_supply:
    discovery:
      sources:
        source(1):
          # Source(1) = The IBMPSG_PowerSupply table
          type: wmi
          query: SELECT DeviceID FROM IBMPSG_PowerSupply
          namespace: root\ibmsd
      mapping:
        # 'The instance table:'
        source: $monitors.power_supply.discovery.sources.source(1)$
        attributes:
          id: $column(1)
          hw.parent.type: enclosure
          hw.parent.id: DIR5
          name: $column(1)
    collect:
      # Collect type : multi instance (one source for several instances)
      type: multiInstance
      sources:
        source(1):
          # Source(1) = the simple IBMPSG_PowerSupply table/class
          # DeviceID;WBEMStatus
          type: wmi
          query: "SELECT DeviceID,Status FROM IBMPSG_PowerSupply"
          namespace: root\ibmsd
          computes:
            # Duplicate the status column
            # DeviceID;WBEMStatus;WBEMStatus
          - type: duplicateColumn
            column: 2
            # Translate the first WBEM status column into a PATROL status
            # DeviceID;PatrolStatus;WBEMStatus
          - type: translate
            column: 2
            translationTable: PowerSupplyStatusTranslationTable
            # Translate the second WBEM status column into a PATROL status
            # DeviceID;PatrolStatus;StatusInformation
          - type: translate
            column: 3
            translationTable: PowerSupplyStatusInformationTranslationTable
      mapping:
        # The ValueTable = Source(1)
        source: $monitors.power_supply.collect.sources.source(1)$
        deviceId: $column(1)
        metrics:
          hw.status{hw.type="power_supply"}: $column(2)
        legacyTextParameters:
          StatusInformation: $column(3)
translations:
  VoltageTypeTranslationTable:
    "22": Remote +18 V
    "23": Remote +1.8 V
    default: ""
    "10": Bus
    "11": +1.25 V
    "12": +1.5 V
    "13": +18 V
    "14": +1.8 V
    "15": Remote +12 V
    "16": Remote -12 V
    "17": Remote +5 V
    "18": Remote +3.3 V
    "19": Remote +2.5 V
    "0": ""
    "1": +2.5a V
    "2": +2.5b V
    "3": +3.3 V
    "4": +5 V
    "5": +12 V
    "6": -12 V
    "7": -5 V
    "8": VIO
    "9": Vcore
    "20": Remote +1.25 V
    "21": Remote +1.5 V
  cpuStatusInformationTranslationTable:
    "1": ""
    "2": Disabled by User
    default: Unknown Status
    "3": Disabled by BIOS (POST Error)
    "4": Idle
    ok: ""
  PowerSupplyStatusTranslationTable:
    stopped: ok
    error: failed
    degraded: degraded
    default: UNKNOWN
    stressed: degraded
    nonrecover: failed
    stopping: degraded
    service: degraded
    no contact: degraded
    lost comm: degraded
    ok: ok
    starting: degraded
    pred fail: degraded
  MemoryBitTranslationTable:
    "13,1": Non-volatile
    "12,1": Cache DRAM
    "10,1": EDO
    "11,1": DRAM
    "1,1": Reserved
    "2,1": Other type
    "3,1": Unknown type
    "4,1": Fast-paged
    "5,1": Static column
    "6,1": Pseudo-static
    "7,1": RAMBUS
    "8,1": Synchronous
    "9,1": CMOS
  TemperatureTypeTranslationTable:
    "1": Motherboard
    "2": CPU
    default: ""
    "3": Power Supply
    "4": DASD
  cpuStatusTranslationTable:
    "1": ok
    "2": ok
    default: UNKNOWN
    "3": failed
    "4": ok
    ok: ok
  FanTypeTranslationTable:
    "1": System
    "2": Power-Supply
    default: ""
    "3": CPU
  memoryStatusTranslationTable:
    "0": ok
    "1": failed
    default: UNKNOWN
    "false": ok
    "true": failed
  PowerSupplyStatusInformationTranslationTable:
    stopped: Stopped
    error: Error
    degraded: Degraded
    default: Unknown Status
    stressed: Stressed
    nonrecover: Non Recover
    stopping: Stopping
    service: Service
    no contact: No Contact
    lost comm: Lost Communication
    ok: ""
    starting: Starting
    pred fail: Predicted Failure
  enclosureIntrusionStatusTranslationTable:
    "0": ok
    "1": ok
    "2": failed
    default: ok
