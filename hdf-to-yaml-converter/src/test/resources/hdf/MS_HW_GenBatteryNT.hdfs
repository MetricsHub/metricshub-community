// HEADER

hdf.DisplayName="WMI - Battery"
hdf.TypicalPlatform="Any system"
hdf.ReliesOn="WMI"
hdf.Version="1.0"
hdf.Comments="This connector provides battery monitoring for Windows computers."
hdf.RemoteSupport="true"
hdf.AppliesToOS="NT"

// DETECTION

Detection.Criteria(1).Type="OS"
Detection.Criteria(1).KeepOnly="NT"

Detection.Criteria(2).Type="Service"
Detection.Criteria(2).ServiceName="WINMGMT"

Detection.Criteria(3).Type="WMI"
Detection.Criteria(3).WbemNameSpace="root\cimv2"
Detection.Criteria(3).WbemQuery="SELECT DeviceID FROM Win32_Battery"

//
// Batteries
//

//
// Discovery
Battery.Discovery.Source(1).Type="WMI"
Battery.Discovery.Source(1).WbemNameSpace="root\cimv2"
Battery.Discovery.Source(1).WbemQuery="SELECT Chemistry, DeviceID, Name FROM Win32_Battery"

// Translate Chemistry
Battery.Discovery.Source(1).Compute(1).Type="Translate"
Battery.Discovery.Source(1).Compute(1).Column="1"
Battery.Discovery.Source(1).Compute(1).TranslationTable="ChemistryTranslationTable"

//
Battery.Discovery.InstanceTable=%Battery.Discovery.Source(1)%
Battery.Discovery.Instance.DeviceID=InstanceTable.Column(2)
Battery.Discovery.Instance.Chemistry=InstanceTable.Column(1)
Battery.Discovery.Instance.Vendor=""
Battery.Discovery.Instance.Model=InstanceTable.Column(3)


// GenericStatusInformationTranslationTable
ChemistryTranslationTable(1)=""
ChemistryTranslationTable(2)=""
ChemistryTranslationTable(3)="Lead Acid"
ChemistryTranslationTable(4)="Nickel Cadmium"
ChemistryTranslationTable(5)="Nickel Metal Hydride"
ChemistryTranslationTable(6)="Lithium-ion"
ChemistryTranslationTable(7)="Zinc Air"
ChemistryTranslationTable(8)="Lithium Polymer"

// COLLECT
Battery.Collect.Type="MultiInstance"

// BatteryStatus, DeviceID, Charge remaining, time left and status
Battery.Collect.Source(1).Type="WMI"
Battery.Collect.Source(1).WbemNameSpace="root\cimv2"
Battery.Collect.Source(1).WbemQuery="SELECT BatteryStatus, DeviceID, EstimatedChargeRemaining, EstimatedRunTime, Status FROM Win32_Battery"

// Duplicate Status to translate it
Battery.Collect.Source(1).Compute(1).Type="DuplicateColumn"
Battery.Collect.Source(1).Compute(1).Column="5"

// Translate Status in an OK, WARN, ALARM status
Battery.Collect.Source(1).Compute(2).Type="Translate"
Battery.Collect.Source(1).Compute(2).Column="5"
Battery.Collect.Source(1).Compute(2).TranslationTable="StatusTranslationTable"

// Translate Status column 3 into a StatusInformation
Battery.Collect.Source(1).Compute(3).Type="Translate"
Battery.Collect.Source(1).Compute(3).Column="6"
Battery.Collect.Source(1).Compute(3).TranslationTable="StatusInformationTranslationTable"

// Translate BatteryStatus into a StatusInformation
Battery.Collect.Source(1).Compute(4).Type="Translate"
Battery.Collect.Source(1).Compute(4).Column="1"
Battery.Collect.Source(1).Compute(4).TranslationTable="BatteryStatusTranslationTable"

// Merge Status StatusInformation and BatteryStatus StatusInformation
Battery.Collect.Source(1).Compute(5).Type="RightConcat"
Battery.Collect.Source(1).Compute(5).Column=6
Battery.Collect.Source(1).Compute(5).String=Column(1)

// A time left of 71582788 indicates that it is charging. Ignore it.
Battery.Collect.Source(1).Compute(6).Type="Replace"
Battery.Collect.Source(1).Compute(6).Column="4"
Battery.Collect.Source(1).Compute(6).Replace="71582788"
Battery.Collect.Source(1).Compute(6).ReplaceBy=""

// Battery StatusInformation (not used anymore at this point), DeviceID, Charge, Time Left (mins), Status, StatusInformation
Battery.Collect.ValueTable=%Battery.Collect.Source(1)%
Battery.Collect.DeviceID=ValueTable.Column(2)
Battery.Collect.Status=ValueTable.Column(5)
Battery.Collect.StatusInformation=ValueTable.Column(6)
Battery.Collect.Charge=ValueTable.Column(3)
Battery.Collect.TimeLeft=ValueTable.Column(4)

StatusTranslationTable("OK")="OK"
StatusTranslationTable("Error")="ALARM"
StatusTranslationTable("Degraded")="WARN"
StatusTranslationTable("Starting")="OK"
StatusTranslationTable("Stopping")="OK"
StatusTranslationTable("Service")="WARN"
StatusTranslationTable("Stressed")="WARN"
StatusTranslationTable("NonRecover")="ALARM"
StatusTranslationTable("No Contact")="WARN"
StatusTranslationTable("Lost Comm")="WARN"
StatusTranslationTable(Default)="UNKNOWN"

StatusInformationTranslationTable("OK")=""
StatusInformationTranslationTable("Error")="Error "
StatusInformationTranslationTable("Degraded")="Degraded "
StatusInformationTranslationTable("Starting")=""
StatusInformationTranslationTable("Stopping")=""
StatusInformationTranslationTable("Service")="Service "
StatusInformationTranslationTable("Stressed")="Stressed "
StatusInformationTranslationTable("NonRecover")="Non Recoverable Error "
StatusInformationTranslationTable("No Contact")="No Contact "
StatusInformationTranslationTable("Lost Comm")="Lost Communication "
StatusInformationTranslationTable(Default)="Unknown "

BatteryStatusTranslationTable(1)="Discharging"
BatteryStatusTranslationTable(2)="On AC"
BatteryStatusTranslationTable(3)="Fully Charged"
BatteryStatusTranslationTable(4)="Low Battery"
BatteryStatusTranslationTable(5)="Critically Low Battery"
BatteryStatusTranslationTable(6)="Charging"
BatteryStatusTranslationTable(7)="Charging and High"
BatteryStatusTranslationTable(8)="Charging and Low"
BatteryStatusTranslationTable(9)="Charging and Critical"
BatteryStatusTranslationTable(10)=""
BatteryStatusTranslationTable(11)="Partially Charged"