////////////////////////////////////////////////////////////////
//
//    H a r d w a r e   D e f i n i t i o n   F i l e
//
//                       f o r
//
//                 Hardware Sentry
//
//                 by Sentry Software (c)
//
//      Supports: HP iLO Gen 9
//                Connects to Redfish REST API via iLO 4
//

//
// Header
//

hdf.DisplayName="HP iLO Gen 9 (REST)"
hdf.TypicalPlatform="HP iLO Gen 9 REST"
hdf.Version="1.0"
hdf.Comments="This connector discovers the status of an HPE Proliant Gen 9 system using iLO 4, as well as the various environment sensors (temperatures, fans, power supplies, etc.). Requires iLO 4."
hdf.RemoteSupport="true"
hdf.LocalSupport="false"
hdf.AppliesToOS="OOB"

//
// DETECTION
//

// Hardware Sentry v10.3.00+
Detection.Criteria(1).Type="KMVersion"
Detection.Criteria(1).Version="10.3.00"

Detection.Criteria(2).Type="HTTP"
Detection.Criteria(2).Method="GET"
Detection.Criteria(2).URL="/redfish/v1/"
Detection.Criteria(2).Header=EmbeddedFile(1)
Detection.Criteria(2).ExpectedResult="iLO 4"
Detection.Criteria(2).ErrorMessage="Invalid credentials / not an HP iLO 4"

#define _REF href
#define _OEM_SPECIFIC OEM/HP/Links
#define _MEMORY_SIZE_PARAMETER SizeMB
#define _MEMORY_STATUS_PATH DIMMStatus
#define _POWER_CONSUMPTION_PATH PowerMetrics/AverageConsumedWatts
#define _FAN_ID FanName
#define _FAN_LOCATION Oem/Hp/Location
#define _PS_ID Oem/Hp/BayNumber
#define _TEMP_ID Number

#include MS_HW_RedfishREST.hhdf

//
// Battery
//

// Discovery

// Query /Systems/?/
Battery.Discovery.Source(1).Type="HTTP"
Battery.Discovery.Source(1).Method="GET"
Battery.Discovery.Source(1).ExecuteForEachEntryOf=%Enclosure.Discovery.Source(3)%
Battery.Discovery.Source(1).Url="%Entry.Column(3)%"
Battery.Discovery.Source(1).Header=EmbeddedFile(1)
Battery.Discovery.Source(1).ResultContent="body"
Battery.Discovery.Source(1).EntryConcatMethod="JSONArrayExtended"

Battery.Discovery.Source(1).Compute(1).Type="Json2Csv"
Battery.Discovery.Source(1).Compute(1).EntryKey="/Entry/Value/Oem/Hp/Battery"
Battery.Discovery.Source(1).Compute(1).Properties="../../../../Column(2);/Index;/SerialNumber;/ProductName;/Model;/Spare;"

Battery.Discovery.Source(1).Compute(2).Type="LeftConcat"
Battery.Discovery.Source(1).Compute(2).Column=7
Battery.Discovery.Source(1).Compute(2).String="Part Number: "

Battery.Discovery.Source(1).Compute(3).Type="LeftConcat"
Battery.Discovery.Source(1).Compute(3).Column=4
Battery.Discovery.Source(1).Compute(3).String="Serial Number: "

// Battery Instance Table
// JSONid;ChassisID;SerialNumber;ElementName;Id;
Battery.Discovery.InstanceTable=%Battery.Discovery.Source(1)%
Battery.Discovery.Instance.DeviceID=InstanceTable.Column(3)
Battery.Discovery.Instance.DisplayID=InstanceTable.Column(5)
Battery.Discovery.Instance.Model=InstanceTable.Column(6)
Battery.Discovery.Instance.AdditionalInformation1=InstanceTable.Column(4)
Battery.Discovery.Instance.AdditionalInformation2=InstanceTable.Column(7)

// Collect

Battery.Collect.Type="MultiInstance"

// Query /Chassis/?/
Battery.Collect.Source(1).Type="HTTP"
Battery.Collect.Source(1).Method="GET"
Battery.Collect.Source(1).ExecuteForEachEntryOf=%Enclosure.Discovery.Source(3)%
Battery.Collect.Source(1).Url="%Entry.Column(3)%"
Battery.Collect.Source(1).Header=EmbeddedFile(1)
Battery.Collect.Source(1).ResultContent="body"
Battery.Collect.Source(1).EntryConcatMethod="JsonArray"

// Extract Data
// JSONId;SerialNumber;Health;health;
Battery.Collect.Source(1).Compute(1).Type="Json2Csv"
Battery.Collect.Source(1).Compute(1).EntryKey="/Oem/Hp/Battery"
Battery.Collect.Source(1).Compute(1).Properties="/Index;/Condition;/Condition;"

Battery.Collect.Source(1).Compute(2).Type="Translate"
Battery.Collect.Source(1).Compute(2).Column=3
Battery.Collect.Source(1).Compute(2).TranslationTable="StatusTranslationTable"

Battery.Collect.Source(1).Compute(3).Type="Translate"
Battery.Collect.Source(1).Compute(3).Column=4
Battery.Collect.Source(1).Compute(3).TranslationTable="StatusInformationTranslationTable"

// Battery Value Table
// JsonID;PatrolStatus;StatusInformation
Battery.Collect.ValueTable=%Battery.Collect.Source(1)%
Battery.Collect.DeviceID=ValueTable.Column(2)
Battery.Collect.Status=ValueTable.Column(3)
Battery.Collect.StatusInformation=ValueTable.Column(4)

// Fiber NetworkCards

// iLO 4
// Query /Chassis/?/NetworkAdapters/
NetworkCard.Discovery.Source(1).Type="HTTP"
NetworkCard.Discovery.Source(1).Method="GET"
NetworkCard.Discovery.Source(1).ExecuteForEachEntryOf=%Enclosure.Discovery.Source(3)%
NetworkCard.Discovery.Source(1).Url="%Entry.Column(3)%NetworkAdapters/"
NetworkCard.Discovery.Source(1).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(1).ResultContent="body"
NetworkCard.Discovery.Source(1).EntryConcatMethod="JSONArrayExtended"

// JSONID;ChassisID;NetworkAdapterURL;
NetworkCard.Discovery.Source(1).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(1).Compute(1).EntryKey="/Entry/Value/Members"
NetworkCard.Discovery.Source(1).Compute(1).Properties="../../Column(2);/@odata.id;"
NetworkCard.Discovery.Source(1).Compute(1).Separator=";"

// Query /Chassis/?/NetworkAdapters/?/
NetworkCard.Discovery.Source(2).Type="HTTP"
NetworkCard.Discovery.Source(2).Method="GET"
NetworkCard.Discovery.Source(2).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(1)%
NetworkCard.Discovery.Source(2).Url="%Entry.Column(3)%"
NetworkCard.Discovery.Source(2).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(2).ResultContent="body"
NetworkCard.Discovery.Source(2).EntryConcatMethod="JSONArrayExtended"

// JsonID;ChassisID;NetworkPorts;Manufacturer;Model;PartNumber;SerialNumber;
// JSONID;ChassisID;Id;Manufacturer;Model;SerialNumber;LinkSpeed;AddressType;Address;   Name;
NetworkCard.Discovery.Source(2).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(2).Compute(1).EntryKey="/Entry/Value/PhysicalPorts"
NetworkCard.Discovery.Source(2).Compute(1).Properties="../../Column(2);/MacAddress;/Name;../Model;../SerialNumber;/SpeedMbps;/MacAddress;"

NetworkCard.Discovery.Source(2).Compute(2).Type="Translate"
NetworkCard.Discovery.Source(2).Compute(2).Column=7
NetworkCard.Discovery.Source(2).Compute(2).TranslationTable="LinkSpeedDeactivationTable"

LinkSpeedDeactivationTable(0)=""
LinkSpeedDeactivationTable("null")=""
LinkSpeedDeactivationTable("StandbyOffline")=""
LinkSpeedDeactivationTable(Default)="True"

NetworkCard.Discovery.Source(2).Compute(3).Type="ExcludeMatchingLines"
NetworkCard.Discovery.Source(2).Compute(3).Column=4
NetworkCard.Discovery.Source(2).Compute(3).ValueList="unknown,null"

NetworkCard.Discovery.Source(2).Compute(4).Type="LeftConcat"
NetworkCard.Discovery.Source(2).Compute(4).Column=10
NetworkCard.Discovery.Source(2).Compute(4).String=" "

NetworkCard.Discovery.Source(2).Compute(5).Type="LeftConcat"
NetworkCard.Discovery.Source(2).Compute(5).Column=10
NetworkCard.Discovery.Source(2).Compute(5).String=Column(12)

NetworkCard.Discovery.InstanceTable=%NetworkCard.Discovery.Source(2)%
NetworkCard.Discovery.Instance.DeviceID=InstanceTable.Column(3)
NetworkCard.Discovery.Instance.DisplayID=InstanceTable.Column(4)
NetworkCard.Discovery.Instance.Model=InstanceTable.Column(5)
NetworkCard.Discovery.Instance.SerialNumber=InstanceTable.Column(6)
NetworkCard.Discovery.Instance.ParameterActivation.LinkSpeed=InstanceTable.Column(7)
NetworkCard.Discovery.Instance.ParameterActivation.LinkStatus=InstanceTable.Column(7)
NetworkCard.Discovery.Instance.PhysicalAddress=InstanceTable.Column(8)

NetworkCard.Collect.Type="MultiInstance"

// NetworkAdapters
NetworkCard.Collect.Source(1).Type="HTTP"
NetworkCard.Collect.Source(1).Method="GET"
NetworkCard.Collect.Source(1).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(1)%
NetworkCard.Collect.Source(1).Url="%Entry.Column(3)%"
NetworkCard.Collect.Source(1).Header=EmbeddedFile(1)
NetworkCard.Collect.Source(1).ResultContent="body"
NetworkCard.Collect.Source(1).EntryConcatMethod="JsonArray"

// PhysicalPortAssignment
NetworkCard.Collect.Source(1).Compute(1).Type="Json2Csv"
NetworkCard.Collect.Source(1).Compute(1).EntryKey="/PhysicalPorts"
NetworkCard.Collect.Source(1).Compute(1).Properties="/MacAddress;/Status/State;/Status/Health;/Status/Health;/SpeedMbps;"
NetworkCard.Collect.Source(1).Compute(1).Separator=";"

NetworkCard.Collect.Source(1).Compute(2).Type="Translate"
NetworkCard.Collect.Source(1).Compute(2).Column=3
NetworkCard.Collect.Source(1).Compute(2).TranslationTable="LinkStatusTranslationTable"

NetworkCard.Collect.Source(1).Compute(3).Type="Translate"
NetworkCard.Collect.Source(1).Compute(3).Column=4
NetworkCard.Collect.Source(1).Compute(3).TranslationTable="NetworkCardStatusTranslationTable"

NetworkCard.Collect.Source(1).Compute(4).Type="Translate"
NetworkCard.Collect.Source(1).Compute(4).Column=5
NetworkCard.Collect.Source(1).Compute(4).TranslationTable="NetworkCardStatusInformationTranslationTable"


// NetworkCard Value Table
// JSON/ID/NetworkCardStatus/LinkStatus/StatusInformation;Speed;
NetworkCard.Collect.ValueTable=%NetworkCard.Collect.Source(1)%
NetworkCard.Collect.DeviceID=ValueTable.Column(2)
NetworkCard.Collect.LinkStatus=ValueTable.Column(3)
NetworkCard.Collect.Status=ValueTable.Column(4)
NetworkCard.Collect.StatusInformation=ValueTable.Column(5)
NetworkCard.Collect.LinkSpeed=ValueTable.Column(6)
