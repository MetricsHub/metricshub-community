////////////////////////////////////////////////////////////////
//
//    H a r d w a r e   D e f i n i t i o n   F i l e
//
//                       f o r
//
//                 Hardware Sentry
//
//                 by Sentry Software (c)
//
//      Supports: HP iLO Gen 10
//                Connects to Redfish REST API via iLO 5
//

//
// Header
//

hdf.DisplayName="HP iLO Gen 10 (REST)"
hdf.TypicalPlatform="HP iLO Gen 10 REST"
hdf.Version="1.0"
hdf.Comments="This connector discovers the status of an HPE Proliant Gen 10 system using iLO 5, as well as the various environment sensors (temperatures, fans, power supplies, etc.). Requires iLO 5."
hdf.RemoteSupport="true"
hdf.LocalSupport="false"
hdf.AppliesToOS="OOB"

//
// DETECTION
//

// Hardware Sentry v10.3.00+
Detection.Criteria(1).Type="KMVersion"
Detection.Criteria(1).Version="10.3.00"

Detection.Criteria(2).Type="HTTP"
Detection.Criteria(2).Method="GET"
Detection.Criteria(2).URL="/redfish/v1/"
Detection.Criteria(2).Header=EmbeddedFile(1)
Detection.Criteria(2).ExpectedResult="iLO 5"
Detection.Criteria(2).ErrorMessage="Invalid credentials / not an HP iLO 5"

#define _REF @odata.id
#define _OEM_SPECIFIC ""
#define _MEMORY_SIZE_PARAMETER VolatileSizeMiB
#define _MEMORY_STATUS_PATH Status/Health
#define _POWER_CONSUMPTION_PATH PowerControl[0]/PowerMetrics/AverageConsumedWatts
#define _FAN_ID Name
#define _FAN_LOCATION Oem/Hpe/Location
#define _PS_ID @odata.id
#define _TEMP_ID @odata.id

#include MS_HW_RedfishREST.hhdf

//
// Battery
//

// Discovery

// Query /Systems/?/
Battery.Discovery.Source(1)=%Enclosure.Discovery.Source(2)%

Battery.Discovery.Source(1).Compute(1).Type="Json2Csv"
Battery.Discovery.Source(1).Compute(1).EntryKey="/Entry/Value/Oem/Hpe/SmartStorageBattery"
Battery.Discovery.Source(1).Compute(1).Properties="../../../../Column(2);/Index;/SerialNumber;/ProductName;/Model;/SparePartNumber;"

Battery.Discovery.Source(1).Compute(2).Type="LeftConcat"
Battery.Discovery.Source(1).Compute(2).Column=7
Battery.Discovery.Source(1).Compute(2).String="Part Number: "

Battery.Discovery.Source(1).Compute(3).Type="LeftConcat"
Battery.Discovery.Source(1).Compute(3).Column=4
Battery.Discovery.Source(1).Compute(3).String="Serial Number: "

// Battery Instance Table
// JSONid;ChassisID;SerialNumber;ElementName;Id;
Battery.Discovery.InstanceTable=%Battery.Discovery.Source(1)%
Battery.Discovery.Instance.DeviceID=InstanceTable.Column(3)
Battery.Discovery.Instance.DisplayID=InstanceTable.Column(5)
Battery.Discovery.Instance.Model=InstanceTable.Column(6)
Battery.Discovery.Instance.AdditionalInformation1=InstanceTable.Column(4)
Battery.Discovery.Instance.AdditionalInformation2=InstanceTable.Column(7)

// Collect

Battery.Collect.Type="MultiInstance"

// Query /Chassis/?/
Battery.Collect.Source(1)=%Enclosure.Collect.Source(1)%

// Extract Data
// JSONId;SerialNumber;Health;health;
Battery.Collect.Source(1).Compute(1).Type="Json2Csv"
Battery.Collect.Source(1).Compute(1).EntryKey="/Oem/Hpe/SmartStorageBattery"
Battery.Collect.Source(1).Compute(1).Properties="/Index;/Status/Health;/Status/Health;/ChargeLevelPercent;"

Battery.Collect.Source(1).Compute(2).Type="Translate"
Battery.Collect.Source(1).Compute(2).Column=3
Battery.Collect.Source(1).Compute(2).TranslationTable="StatusTranslationTable"

Battery.Collect.Source(1).Compute(3).Type="Translate"
Battery.Collect.Source(1).Compute(3).Column=4
Battery.Collect.Source(1).Compute(3).TranslationTable="StatusInformationTranslationTable"

// Battery Value Table
// JsonID;PatrolStatus;StatusInformation
Battery.Collect.ValueTable=%Battery.Collect.Source(1)%
Battery.Collect.DeviceID=ValueTable.Column(2)
Battery.Collect.Status=ValueTable.Column(3)
Battery.Collect.StatusInformation=ValueTable.Column(4)
Battery.Collect.Charge=ValueTable.Column(5)



// EthernetInterfaces
// Discovery
NetworkCard.Discovery.Source(1).Type="HTTP"
NetworkCard.Discovery.Source(1).Method="GET"
NetworkCard.Discovery.Source(1).ExecuteForEachEntryOf=%Enclosure.Discovery.Source(3)%
NetworkCard.Discovery.Source(1).Url="%Entry.Column(3)%EthernetInterfaces/"
NetworkCard.Discovery.Source(1).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(1).ResultContent="body"
NetworkCard.Discovery.Source(1).EntryConcatMethod="JSONArrayExtended"

// JSONID;ChassisID;EthernetURL;
NetworkCard.Discovery.Source(1).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(1).Compute(1).EntryKey="/Entry/Value/Members"
NetworkCard.Discovery.Source(1).Compute(1).Properties="../../Column(2);/@odata.id;"
NetworkCard.Discovery.Source(1).Compute(1).Separator=";"

//remove empty ethernetURL to avoid empty redirection

NetworkCard.Discovery.Source(1).Compute(2).Type="KeepOnlyMatchingLines"
NetworkCard.Discovery.Source(1).Compute(2).Column=3
NetworkCard.Discovery.Source(1).Compute(2).RegExp="."

// Query each EthernetURL
NetworkCard.Discovery.Source(2).Type="HTTP"
NetworkCard.Discovery.Source(2).Method="GET"
NetworkCard.Discovery.Source(2).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(1)%
NetworkCard.Discovery.Source(2).Url="%Entry.Column(3)%"
NetworkCard.Discovery.Source(2).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(2).ResultContent="body"
NetworkCard.Discovery.Source(2).EntryConcatMethod="JSONArrayExtended"

// Extract data
// JSONID;ChassisID;EthernetID;Name;blank;blank;Speed;MACAddress;Name;
NetworkCard.Discovery.Source(2).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(2).Compute(1).EntryKey="/Entry/Value"
NetworkCard.Discovery.Source(2).Compute(1).Properties="../Column(2);/@odata.id;/null;/null;/null;/SpeedMbps;/MACAddress;/Name;"

NetworkCard.Discovery.Source(2).Compute(2).Type="Translate"
NetworkCard.Discovery.Source(2).Compute(2).Column=7
NetworkCard.Discovery.Source(2).Compute(2).TranslationTable="EthernetInterfacesLinkSpeedDeactivationTable"

EthernetInterfacesLinkSpeedDeactivationTable("null")=""
EthernetInterfacesLinkSpeedDeactivationTable("StandbyOffline")=""
EthernetInterfacesLinkSpeedDeactivationTable(Default)="True"

// JSONID;ChassisID;EthernetID;Name;blank;blank;Speed;MAC;MACAddress;Name;
NetworkCard.Discovery.Source(2).Compute(3).Type="LeftConcat"
NetworkCard.Discovery.Source(2).Compute(3).Column=8
NetworkCard.Discovery.Source(2).Compute(3).String="MAC;"

// Fiber NetworkCards

// iLO 5
NetworkCard.Discovery.Source(3).Type="HTTP"
NetworkCard.Discovery.Source(3).Method="GET"
NetworkCard.Discovery.Source(3).ExecuteForEachEntryOf=%Enclosure.Discovery.Source(1)%
NetworkCard.Discovery.Source(3).Url="%Entry.Column(2)%NetworkAdapters/"
NetworkCard.Discovery.Source(3).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(3).ResultContent="body"
NetworkCard.Discovery.Source(3).EntryConcatMethod="JSONArrayExtended"

// JSONID;ChassisID;NetworkAdapterURL;
NetworkCard.Discovery.Source(3).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(3).Compute(1).EntryKey="/Entry/Value/Members"
NetworkCard.Discovery.Source(3).Compute(1).Properties="../../Column(2);/@odata.id;"
NetworkCard.Discovery.Source(3).Compute(1).Separator=";"

//Remove empty network url to avoid errors
NetworkCard.Discovery.Source(3).Compute(2).Type="KeepOnlyMatchingLines"
NetworkCard.Discovery.Source(3).Compute(2).Column=3
NetworkCard.Discovery.Source(3).Compute(2).RegExp="."

// Query /Chassis/?/NetworkAdapters/?/
NetworkCard.Discovery.Source(4).Type="HTTP"
NetworkCard.Discovery.Source(4).Method="GET"
NetworkCard.Discovery.Source(4).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(3)%
NetworkCard.Discovery.Source(4).Url="%Entry.Column(3)%"
NetworkCard.Discovery.Source(4).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(4).ResultContent="body"
NetworkCard.Discovery.Source(4).EntryConcatMethod="JSONArrayExtended"

// JsonID;ChassisID;NetworkPorts;Manufacturer;Model;PartNumber;SerialNumber;
NetworkCard.Discovery.Source(4).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(4).Compute(1).EntryKey="/Entry/Value/NetworkPorts"
NetworkCard.Discovery.Source(4).Compute(1).Properties="../../Column(2);/@odata.id;../Manufacturer;../Model;../PartNumber;../SerialNumber;;;/Name;"

// NetworkPorts
// Query /Chassis/?/NetworkAdapters/?/NetworkPorts/?/
NetworkCard.Discovery.Source(5).Type="HTTP"
NetworkCard.Discovery.Source(5).Method="GET"
NetworkCard.Discovery.Source(5).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(4)%
NetworkCard.Discovery.Source(5).Url="%Entry.Column(3)%"
NetworkCard.Discovery.Source(5).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(5).ResultContent="body"
NetworkCard.Discovery.Source(5).EntryConcatMethod="JSONArrayExtended"

// JsonID;ChassisID;NetworkPort;Manufacturer;Model;PartNumber;SerialNumber;
NetworkCard.Discovery.Source(5).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(5).Compute(1).EntryKey="/Entry/Value/Members"
NetworkCard.Discovery.Source(5).Compute(1).Properties="../../Column(2);/@odata.id;../../Column(4);../../Column(5);../../Column(7);"
NetworkCard.Discovery.Source(5).Compute(1).Separator=";"


//remove empty ethernetURL to avoid empty redirection

NetworkCard.Discovery.Source(5).Compute(2).Type="KeepOnlyMatchingLines"
NetworkCard.Discovery.Source(5).Compute(2).Column=3
NetworkCard.Discovery.Source(5).Compute(2).RegExp="."


// PhysicalPortAssignment
NetworkCard.Discovery.Source(6).Type="HTTP"
NetworkCard.Discovery.Source(6).Method="GET"
NetworkCard.Discovery.Source(6).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(5)%
NetworkCard.Discovery.Source(6).Url="%Entry.Column(3)%"
NetworkCard.Discovery.Source(6).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(6).ResultContent="body"
NetworkCard.Discovery.Source(6).EntryConcatMethod="JSONArrayExtended"

// PhysicalPortAssignment
// JsonID;ChassisID;ID;Model;SerialNumber;Manufacturer;LinkSpeed;(FC/Eth);Address;Name;
NetworkCard.Discovery.Source(6).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(6).Compute(1).EntryKey="/Entry/Value"
NetworkCard.Discovery.Source(6).Compute(1).Properties="../Column(2);/Id;../Column(6);../Column(7);../Column(4);/SupportedLinkCapabilities[0]/CapableLinkSpeedMbps;/ActiveLinkTechnology;/AssociatedNetworkAddresses[0];/Name;"
NetworkCard.Discovery.Source(6).Compute(1).Separator=";"

NetworkCard.Discovery.Source(6).Compute(2).Type="Translate"
NetworkCard.Discovery.Source(6).Compute(2).Column=7
NetworkCard.Discovery.Source(6).Compute(2).TranslationTable="LinkSpeedDeactivationTranslationTable"

LinkSpeedDeactivationTranslationTable(0)=""
LinkSpeedDeactivationTranslationTable(Default)="True"


// Fiber NetworkCards

// iLO 5
NetworkCard.Discovery.Source(7).Type="HTTP"
NetworkCard.Discovery.Source(7).Method="GET"
NetworkCard.Discovery.Source(7).ExecuteForEachEntryOf=%Enclosure.Discovery.Source(3)%
NetworkCard.Discovery.Source(7).Url="%Entry.Column(3)%BaseNetworkAdapters/"
NetworkCard.Discovery.Source(7).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(7).ResultContent="body"
NetworkCard.Discovery.Source(7).EntryConcatMethod="JSONArrayExtended"

// JSONID;ChassisID;NetworkAdapterURL;
NetworkCard.Discovery.Source(7).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(7).Compute(1).EntryKey="/Entry/Value/Members"
NetworkCard.Discovery.Source(7).Compute(1).Properties="../../Column(2);/@odata.id;"
NetworkCard.Discovery.Source(7).Compute(1).Separator=";"


//remove empty ethernetURL to avoid empty redirection

NetworkCard.Discovery.Source(7).Compute(2).Type="KeepOnlyMatchingLines"
NetworkCard.Discovery.Source(7).Compute(2).Column=3
NetworkCard.Discovery.Source(7).Compute(2).RegExp="."

// Query /Chassis/?/NetworkAdapters/?/
NetworkCard.Discovery.Source(8).Type="HTTP"
NetworkCard.Discovery.Source(8).Method="GET"
NetworkCard.Discovery.Source(8).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(7)%
NetworkCard.Discovery.Source(8).Url="%Entry.Column(3)%"
NetworkCard.Discovery.Source(8).Header=EmbeddedFile(1)
NetworkCard.Discovery.Source(8).ResultContent="body"
NetworkCard.Discovery.Source(8).EntryConcatMethod="JSONArrayExtended"

// JsonID;ChassisID;ID;null;PartNumber;SerialNumber;null;null;null;WWPN;Name
NetworkCard.Discovery.Source(8).Compute(1).Type="Json2Csv"
NetworkCard.Discovery.Source(8).Compute(1).EntryKey="/Entry/Value/FcPorts"
NetworkCard.Discovery.Source(8).Compute(1).Properties="../../Column(2);/WWPN;/null;../PartNumber;../SerialNumber;/null;/WWPN;../Name;"

// JsonID;ChassisID;ID;null;PartNumber;SerialNumber;null;null;Type;WWPN;Name
// NetworkSpeed not available for FCPorts
NetworkCard.Discovery.Source(8).Compute(2).Type="RightConcat"
NetworkCard.Discovery.Source(8).Compute(2).Column=7
NetworkCard.Discovery.Source(8).Compute(2).String=";WWPN"

// Keep only FC
NetworkCard.Discovery.Source(8).Compute(3).Type="KeepOnlyMatchingLines"
NetworkCard.Discovery.Source(8).Compute(3).Column=3
NetworkCard.Discovery.Source(8).Compute(3).RegExp="."

// Make unique name
NetworkCard.Discovery.Source(8).Compute(4).Type="RightConcat"
NetworkCard.Discovery.Source(8).Compute(4).Column=10
NetworkCard.Discovery.Source(8).Compute(4).String=" "

NetworkCard.Discovery.Source(8).Compute(5).Type="RightConcat"
NetworkCard.Discovery.Source(8).Compute(5).Column=10
NetworkCard.Discovery.Source(8).Compute(5).String=Column(3)

// FC should always exist in BaseNetworkAdapters. (Table 8)
// Suppliment with data from table 6 only in fields that are null from table 8.
// This avoids duplicates.

// Left   // JsonID;ChassisID;ID;null;PartNumber;SerialNumber;null;Type;WWPN;Name
// Right  // JsonID;ChassisID;ID;Model;SerialNumber;Manufacturer;LinkSpeed;(FC/Eth);Address;Name;
NetworkCard.Discovery.Source(9).Type="TableJoint"
NetworkCard.Discovery.Source(9).LeftTable=%NetworkCard.Discovery.Source(8)%
NetworkCard.Discovery.Source(9).RightTable=%NetworkCard.Discovery.Source(6)%
NetworkCard.Discovery.Source(9).LeftKeyColumn=9
NetworkCard.Discovery.Source(9).RightKeyColumn=9
NetworkCard.Discovery.Source(9).DefaultRightLine="Something to eliminate duplicates"


// Json;ChassisId;Id;Model;SerialNumber;Vendor;LinkSpeedActivation;
NetworkCard.Discovery.Source(9).Compute(1).Type="KeepColumns"
NetworkCard.Discovery.Source(9).Compute(1).ColumnNumbers="1,2,3,5,6,7,8,9,10,16"

// ColumnNumbers does not respect the order you specify, so move things around.
NetworkCard.Discovery.Source(9).Compute(2).Type="DuplicateColumn"
NetworkCard.Discovery.Source(9).Compute(2).Column=5

NetworkCard.Discovery.Source(9).Compute(3).Type="Replace"
NetworkCard.Discovery.Source(9).Compute(3).Column=6
NetworkCard.Discovery.Source(9).Compute(3).Replace=Column(6)
NetworkCard.Discovery.Source(9).Compute(3).ReplaceBy=Column(11)

// JSONID;ChassisID;ID;blank;blank;       blank;       Speed;               MAC;     Address;Name;
// JsonID;ChassisID;ID;Model;SerialNumber;Manufacturer;CapableLinkSpeedMbps;(FC/Eth);Address;Name
NetworkCard.Discovery.Source(10).Type="TableUnion"
NetworkCard.Discovery.Source(10).Table1=%NetworkCard.Discovery.Source(9)%
NetworkCard.Discovery.Source(10).Table2=%NetworkCard.Discovery.Source(2)%

// NetworkCard Instance Table
// JsondId;<System>;Id;Manufacturer;Model;SerialNumber;LinkSpeed;Ethernet/FC;MACAddress/WWPN;
NetworkCard.Discovery.InstanceTable=%NetworkCard.Discovery.Source(10)%
NetworkCard.Discovery.Instance.DeviceID=InstanceTable.Column(3)
NetworkCard.Discovery.Instance.DisplayID=InstanceTable.Column(10)
NetworkCard.Discovery.Instance.Model=InstanceTable.Column(4)
NetworkCard.Discovery.Instance.SerialNumber=InstanceTable.Column(5)
NetworkCard.Discovery.Instance.Vendor=InstanceTable.Column(6)
NetworkCard.Discovery.Instance.ParameterActivation.LinkSpeed=InstanceTable.Column(7)
NetworkCard.Discovery.Instance.PhysicalAddressType=InstanceTable.Column(8)
NetworkCard.Discovery.Instance.PhysicalAddress=InstanceTable.Column(9)

// Collect
// EthernetInterfaces
NetworkCard.Collect.Type="MultiInstance"

NetworkCard.Collect.Source(1).Type="HTTP"
NetworkCard.Collect.Source(1).Method="GET"
NetworkCard.Collect.Source(1).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(1)%
NetworkCard.Collect.Source(1).Url="%Entry.Column(3)%"
NetworkCard.Collect.Source(1).Header=EmbeddedFile(1)
NetworkCard.Collect.Source(1).ResultContent="body"
NetworkCard.Collect.Source(1).EntryConcatMethod="JSONArray"

// JSONID;EthernetID;LinkStatus;Health;Health;Speed;
NetworkCard.Collect.Source(1).Compute(1).Type="Json2Csv"
NetworkCard.Collect.Source(1).Compute(1).EntryKey="/"
NetworkCard.Collect.Source(1).Compute(1).Properties="/@odata.id;/LinkStatus;/Status/Health;/Status/Health;/SpeedMbps;"

// NetworkAdapters
NetworkCard.Collect.Source(2).Type="HTTP"
NetworkCard.Collect.Source(2).Method="GET"
NetworkCard.Collect.Source(2).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(5)%
NetworkCard.Collect.Source(2).Url="%Entry.Column(3)%"
NetworkCard.Collect.Source(2).Header=EmbeddedFile(1)
NetworkCard.Collect.Source(2).ResultContent="body"
NetworkCard.Collect.Source(2).EntryConcatMethod="JsonArray"

// PhysicalPortAssignment
NetworkCard.Collect.Source(2).Compute(1).Type="Json2Csv"
NetworkCard.Collect.Source(2).Compute(1).EntryKey="/"
NetworkCard.Collect.Source(2).Compute(1).Properties="/Id;/LinkStatus;/LinkStatus;/LinkStatus;/CurrentLinkSpeedMbps;"
NetworkCard.Collect.Source(2).Compute(1).Separator=";"

NetworkCard.Collect.Source(3).Type="HTTP"
NetworkCard.Collect.Source(3).Method="GET"
NetworkCard.Collect.Source(3).ExecuteForEachEntryOf=%NetworkCard.Discovery.Source(7)%
NetworkCard.Collect.Source(3).Url="%Entry.Column(3)%"
NetworkCard.Collect.Source(3).Header=EmbeddedFile(1)
NetworkCard.Collect.Source(3).ResultContent="body"
NetworkCard.Collect.Source(3).EntryConcatMethod="JsonArray"

NetworkCard.Collect.Source(3).Compute(1).Type="Json2Csv"
NetworkCard.Collect.Source(3).Compute(1).EntryKey="/FcPorts"
NetworkCard.Collect.Source(3).Compute(1).Properties="/WWPN;../Status/Health;../Status/Health;../Status/Health;"
NetworkCard.Collect.Source(3).Compute(1).Separator=";"

NetworkCard.Collect.Source(4).Type="TableUnion"
NetworkCard.Collect.Source(4).Table1=%NetworkCard.Collect.Source(1)%
NetworkCard.Collect.Source(4).Table2=%NetworkCard.Collect.Source(2)%
NetworkCard.Collect.Source(4).Table3=%NetworkCard.Collect.Source(3)%

NetworkCard.Collect.Source(4).Compute(1).Type="Translate"
NetworkCard.Collect.Source(4).Compute(1).Column=3
NetworkCard.Collect.Source(4).Compute(1).TranslationTable="LinkStatusTranslationTable"

NetworkCard.Collect.Source(4).Compute(2).Type="Translate"
NetworkCard.Collect.Source(4).Compute(2).Column=4
NetworkCard.Collect.Source(4).Compute(2).TranslationTable="NetworkCardStatusTranslationTable"

NetworkCard.Collect.Source(4).Compute(3).Type="Translate"
NetworkCard.Collect.Source(4).Compute(3).Column=5
NetworkCard.Collect.Source(4).Compute(3).TranslationTable="NetworkCardStatusInformationTranslationTable"

// NetworkCard Value Table
// JSON/ID/NetworkCardStatus/LinkStatus/StatusInformation;Speed;
NetworkCard.Collect.ValueTable=%NetworkCard.Collect.Source(4)%
NetworkCard.Collect.DeviceID=ValueTable.Column(2)
NetworkCard.Collect.LinkStatus=ValueTable.Column(3)
NetworkCard.Collect.Status=ValueTable.Column(4)
NetworkCard.Collect.StatusInformation=ValueTable.Column(5)
NetworkCard.Collect.LinkSpeed=ValueTable.Column(6)
