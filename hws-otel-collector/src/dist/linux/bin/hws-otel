#!/bin/sh

# Licensed under the Sentry Free Software License Agreement.
# See the LICENSE file distributed with this work for additional
# information regarding copyright ownership.
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

# ════════════════════════════════════════════════════════════════════════════
# ╦ ╦┌─┐┬─┐┌┬┐┬ ┬┌─┐┬─┐┌─┐  ╔═╗┌─┐┌┐┌┌┬┐┬─┐┬ ┬
# ╠═╣├─┤├┬┘ │││││├─┤├┬┘├┤   ╚═╗├┤ │││ │ ├┬┘└┬┘
# ╩ ╩┴ ┴┴└──┴┘└┴┘┴ ┴┴└─└─┘  ╚═╝└─┘┘└┘ ┴ ┴└─ ┴
#
# Hardware Sentry OpenTelemetry Collector Startup Script
#
# Version ${project.version}
# Build ${buildNumber} on ${timestamp}
# ════════════════════════════════════════════════════════════════════════════

# Resolve links - $0 may be a link to Hardware Sentry OpenTelemetry Collector's home
PRG="$0"

# Need this for relative symlinks
while [ -h "$PRG" ] ; do
	ls=`ls -ld "$PRG"`
	link=`expr "$ls" : '.*-> \(.*\)$'`
	if expr "$link" : '/.*' > /dev/null; then
		PRG="$link"
	else
		PRG="`dirname "$PRG"`/$link"
	fi
done

# Remember where we are
saveddir=`pwd`

HWS_HOME=`dirname "$PRG"`/..

# Make it fully qualified
HWS_HOME=`cd "$HWS_HOME" && pwd`

# If no arguments specified, use the default config file
if [ -z "$1" ]; then
	DEFAULT_ARG1=--config
	DEFAULT_ARG2=config/otel-config.yaml
fi

# Execute
cd "$HWS_HOME"
/usr/bin/mv -f logs/otel~2.log logs/otel~3.log > /dev/null 2>&1
/usr/bin/mv -f logs/otel~1.log logs/otel~2.log > /dev/null 2>&1
/usr/bin/mv -f logs/otel.log logs/otel~1.log > /dev/null 2>&1
exec "bin/${project.artifactId}" $DEFAULT_ARG1 $DEFAULT_ARG2 $@ > logs/otel.log 2>&1

# Go back to where we were
cd "$saveddir"

