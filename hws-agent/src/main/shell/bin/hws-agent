#!/bin/sh

# Licensed under the Sentry Free Software License Agreement.
# See the LICENSE file distributed with this work for additional
# information regarding copyright ownership.
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

# -----------------------------------------------------------------------------
# Hardware Sentry Agent Startup Script
#
# Environment Variable Prerequisites
#
#   JAVA_HOME       Must point at a Java Runtime Environment, version 11 or
#                   greater.
#   HWS_JAVA_OPTS   (Optional) Java runtime options used when Hardware Sentry
#                   Agent is executed.
# -----------------------------------------------------------------------------

# Resolve links - $0 may be a link to Hardware Sentry Agent's home
PRG="$0"

# Need this for relative symlinks
while [ -h "$PRG" ] ; do
	ls=`ls -ld "$PRG"`
	link=`expr "$ls" : '.*-> \(.*\)$'`
	if expr "$link" : '/.*' > /dev/null; then
		PRG="$link"
	else
		PRG="`dirname "$PRG"`/$link"
	fi
done

# Remember where we are
saveddir=`pwd`

HWS_HOME=`dirname "$PRG"`/..

# Make it fully qualified
HWS_HOME=`cd "$HWS_HOME" && pwd`

# Go back to where we were
cd "$saveddir"

# Check JAVA_HOME
if [ -z "$JAVA_HOME" ] ; then
	JAVACMD=`which java`
else
	JAVACMD="$JAVA_HOME/bin/java"
fi

if [ ! -x "$JAVACMD" ] ; then
  echo "The JAVA_HOME environment variable is not defined correctly." >&2
  echo "JAVA_HOME must point to a JRE version 11 or greater." >&2
  exit 1
fi

HWS_JAR=`echo "$HWS_HOME"/lib/hws-agent-2.0.01-SNAPSHOT.jar`
OTEL_JAR=`echo "$HWS_HOME"/otel/opentelemetry-javaagent.jar`
OTLP_CERT=`echo "$HWS_HOME"/security/otel.crt`
OTLP_HEADER="Authorization=Basic aHdzOlNlbnRyeVNvZnR3YXJlMSE="

HWS_AUTO_INST="auto"

# Auto-instrumentation is enabled by default
for arg in "$@" ; do
  if [ "$arg" = "--no-auto-instrumentation" ] ; then
    echo "Auto-instrumentation is disabled" && HWS_AUTO_INST="" && break
  fi
done

if [ $HWS_AUTO_INST == "auto" ]
then
   exec "$JAVACMD" $HWS_JAVA_OPTS -javaagent:"$OTEL_JAR" -Dotel.resource.attributes=service.name=agent-service -Dotel.traces.exporter=otlp -Dotel.metrics.exporter=otlp -Dotel.exporter.otlp.endpoint=https://localhost:4317 -Dotel.exporter.otlp.certificate="$OTLP_CERT" -Dotel.exporter.otlp.headers="$OTLP_HEADER" -jar "${HWS_JAR}" "$@"
else
   exec "$JAVACMD" $HWS_JAVA_OPTS -jar "${HWS_JAR}" "$@"
fi
